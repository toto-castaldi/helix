---
phase: 14-domain-routing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/nginx-helix-web.conf
  - config/nginx-helix-coach.conf
  - config/nginx-helix-landing.conf
autonomous: false
requirements: [DOM-01, DOM-02, DOM-03]
user_setup:
  - service: GoDaddy DNS
    why: "DNS A record for coach.helix.toto-castaldi.com"
    dashboard_config:
      - task: "Create A record for coach.helix.toto-castaldi.com pointing to same IP as helix.toto-castaldi.com"
        location: "GoDaddy DNS Management for toto-castaldi.com"
  - service: DigitalOcean Droplet
    why: "Deploy Nginx configs and obtain HTTPS certificates"
    dashboard_config:
      - task: "SSH to droplet, copy Nginx configs, run certbot, reload Nginx"
        location: "SSH terminal to droplet"
  - service: Supabase Dashboard
    why: "Add coach.helix.toto-castaldi.com to auth redirect URLs"
    dashboard_config:
      - task: "Add https://coach.helix.toto-castaldi.com to Redirect URLs in Authentication > URL Configuration"
        location: "Supabase Dashboard > Authentication > URL Configuration"
  - service: Google Cloud Console
    why: "Add coach.helix.toto-castaldi.com to authorized redirect URIs for Google OAuth"
    dashboard_config:
      - task: "Add https://coach.helix.toto-castaldi.com as authorized JavaScript origin and redirect URI"
        location: "Google Cloud Console > APIs & Services > Credentials > OAuth 2.0 Client"

must_haves:
  truths:
    - "helix.toto-castaldi.com serves the landing page (dist-landing)"
    - "coach.helix.toto-castaldi.com serves the coach app (dist)"
    - "live.helix.toto-castaldi.com continues to serve the live tablet app unchanged"
    - "All three domains have valid HTTPS certificates"
    - "Google OAuth login works on coach.helix.toto-castaldi.com"
  artifacts:
    - path: "config/nginx-helix-landing.conf"
      provides: "Nginx config for helix.toto-castaldi.com serving landing page"
      contains: "server_name helix.toto-castaldi.com"
    - path: "config/nginx-helix-coach.conf"
      provides: "Nginx config for coach.helix.toto-castaldi.com serving coach app"
      contains: "server_name coach.helix.toto-castaldi.com"
    - path: "config/nginx-helix-live.conf"
      provides: "Existing Nginx config for live.helix.toto-castaldi.com (unchanged)"
      contains: "server_name live.helix.toto-castaldi.com"
  key_links:
    - from: "config/nginx-helix-landing.conf"
      to: "/var/www/helix-landing"
      via: "root directive"
      pattern: "root /var/www/helix-landing"
    - from: "config/nginx-helix-coach.conf"
      to: "/var/www/helix"
      via: "root directive"
      pattern: "root /var/www/helix"
---

<objective>
Create Nginx configuration files for the three-domain architecture, update the existing helix.toto-castaldi.com config to serve the landing page instead of the coach app, create a new config for coach.helix.toto-castaldi.com, and provide a complete deployment runbook for the user to execute DNS, Nginx, HTTPS, and auth configuration changes.

Purpose: Each Helix application gets its own domain with proper isolation and HTTPS.
Output: Three Nginx config files in repo + deployment instructions the user follows.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-domain-routing/14-CONTEXT.md
@.planning/phases/12-landing-build-setup/12-01-SUMMARY.md
@.planning/phases/13-landing-page-content/13-01-SUMMARY.md
@config/nginx-helix-web.conf
@config/nginx-helix-live.conf
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create three-domain Nginx configuration files</name>
  <files>
    config/nginx-helix-landing.conf
    config/nginx-helix-coach.conf
    config/nginx-helix-web.conf
  </files>
  <action>
Create three Nginx config files following the established pattern from `config/nginx-helix-live.conf` as reference.

**1. `config/nginx-helix-landing.conf`** (NEW - replaces nginx-helix-web.conf for helix.toto-castaldi.com):
- `server_name helix.toto-castaldi.com;`
- `root /var/www/helix-landing;` (new document root for landing page)
- `index landing.html;` (the landing page entry point from dist-landing/)
- Gzip compression (same as live config)
- Cache static assets under `/assets/` with 1y expiry
- SPA fallback: `try_files $uri $uri/ /landing.html;`
- HTTP-to-HTTPS redirect server block (port 80 -> 301 to HTTPS)
- HTTPS server block on port 443 with SSL placeholder comments (certbot will fill in actual cert paths)
- NOTE: This is a static landing page, not a React SPA, but the try_files fallback is harmless and consistent

**2. `config/nginx-helix-coach.conf`** (NEW - coach app on its subdomain):
- `server_name coach.helix.toto-castaldi.com;`
- `root /var/www/helix;` (same document root as the current coach app - no change to deployment path)
- `index index.html;` (the React coach app entry point)
- Gzip compression (same pattern)
- Cache static assets under `/assets/` with 1y expiry
- SPA fallback: `try_files $uri $uri/ /index.html;`
- HTTP-to-HTTPS redirect server block
- HTTPS server block with SSL placeholder comments

**3. Delete `config/nginx-helix-web.conf`** (the old config for helix.toto-castaldi.com that served the coach app):
- This file is replaced by `nginx-helix-landing.conf` and `nginx-helix-coach.conf`
- Use `git rm config/nginx-helix-web.conf` to remove it

For the SSL sections in both new files, use comment placeholders like this (matching the style of the existing configs):
```
    # SSL
    # Managed by Certbot - run certbot to populate
    # ssl_certificate /etc/letsencrypt/live/{domain}/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/{domain}/privkey.pem;
    # include /etc/letsencrypt/options-ssl-nginx.conf;
    # ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
```

Keep the `config/nginx-helix-live.conf` completely unchanged (per decision: live is already fully set up).
  </action>
  <verify>
    - `config/nginx-helix-landing.conf` exists and contains `server_name helix.toto-castaldi.com`
    - `config/nginx-helix-coach.conf` exists and contains `server_name coach.helix.toto-castaldi.com`
    - `config/nginx-helix-web.conf` is removed (git rm)
    - `config/nginx-helix-live.conf` is unchanged
    - All new configs follow the same structure as the live config
  </verify>
  <done>Three Nginx config files exist in config/ for landing, coach, and live domains. The old nginx-helix-web.conf is removed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: User deploys DNS, Nginx, HTTPS, and auth configuration</name>
  <what-built>
Nginx configuration files for three-domain architecture:
- `config/nginx-helix-landing.conf` - helix.toto-castaldi.com serves landing page
- `config/nginx-helix-coach.conf` - coach.helix.toto-castaldi.com serves coach app
- `config/nginx-helix-live.conf` - live.helix.toto-castaldi.com unchanged

These are ready for deployment. Follow the runbook below.
  </what-built>
  <how-to-verify>

## Deployment Runbook

### Step 1: DNS Setup (GoDaddy)

Create ONE new DNS record:

| Type | Name | Value | TTL |
|------|------|-------|-----|
| A | coach.helix | (same IP as helix.toto-castaldi.com) | 600 |

Verify: `dig coach.helix.toto-castaldi.com` should resolve to your droplet IP.

Wait for DNS propagation (may take a few minutes with TTL 600).

### Step 2: Deploy Nginx Configs (SSH to droplet)

```bash
# SSH to your droplet
ssh user@your-droplet-ip

# Create landing page document root
sudo mkdir -p /var/www/helix-landing

# Copy a temporary landing.html so Nginx can start
echo "<h1>Landing coming soon</h1>" | sudo tee /var/www/helix-landing/landing.html

# Remove old config
sudo rm /etc/nginx/sites-enabled/nginx-helix-web.conf 2>/dev/null
sudo rm /etc/nginx/sites-available/nginx-helix-web.conf 2>/dev/null

# Copy new configs from your local repo to the server
# (from your LOCAL machine, not on the server)
scp config/nginx-helix-landing.conf user@your-droplet-ip:/tmp/
scp config/nginx-helix-coach.conf user@your-droplet-ip:/tmp/

# Back on the SERVER:
sudo cp /tmp/nginx-helix-landing.conf /etc/nginx/sites-available/
sudo cp /tmp/nginx-helix-coach.conf /etc/nginx/sites-available/
sudo ln -sf /etc/nginx/sites-available/nginx-helix-landing.conf /etc/nginx/sites-enabled/
sudo ln -sf /etc/nginx/sites-available/nginx-helix-coach.conf /etc/nginx/sites-enabled/

# Test config
sudo nginx -t

# Reload Nginx (HTTP only first, before certbot)
sudo systemctl reload nginx
```

### Step 3: HTTPS Certificates (on droplet)

```bash
# Get certificate for the landing domain (re-issue since root changed)
sudo certbot --nginx -d helix.toto-castaldi.com

# Get certificate for the new coach subdomain
sudo certbot --nginx -d coach.helix.toto-castaldi.com

# Verify Nginx still works
sudo nginx -t && sudo systemctl reload nginx
```

### Step 4: Auth Configuration

**Supabase Dashboard** (https://supabase.com/dashboard):
1. Go to your project > Authentication > URL Configuration
2. In "Redirect URLs", add: `https://coach.helix.toto-castaldi.com`
3. Optionally update "Site URL" to `https://coach.helix.toto-castaldi.com` (this is the default redirect)
4. Save

**Google Cloud Console** (https://console.cloud.google.com):
1. Go to APIs & Services > Credentials
2. Click on your OAuth 2.0 Client ID
3. Under "Authorized JavaScript origins", add: `https://coach.helix.toto-castaldi.com`
4. Under "Authorized redirect URIs", add: `https://coach.helix.toto-castaldi.com` (Supabase handles the actual callback)
5. Save

### Step 5: Verification Checklist

Test each domain:
1. `https://helix.toto-castaldi.com` - Shows landing page with Helix hero, features, CTA
2. `https://coach.helix.toto-castaldi.com` - Shows coach app login page, Google OAuth works
3. `https://live.helix.toto-castaldi.com` - Shows live tablet app (unchanged)

### Step 6: External Service URL Audit

Check these services for references to the old `helix.toto-castaldi.com` (which was the coach app):

| Service | What to check | Action needed? |
|---------|---------------|----------------|
| **Supabase Auth Redirect URLs** | Redirect URL list | Add coach.helix subdomain (Step 4) |
| **Google Cloud Console** | OAuth redirect URIs | Add coach.helix subdomain (Step 4) |
| **Docora Webhooks** | Webhook callback URL | No - callbacks go to Supabase Edge Functions domain, not helix domain |
| **GitHub OAuth (if any)** | Callback URL | Only if GitHub OAuth is configured (check Supabase Auth providers) |
| **MCP Server** | Endpoint URL | No - MCP runs on Supabase Edge Functions domain |
| **Supabase OAuth Server** | Consent page URL | The consent page is served by the coach app at `/oauth/consent`. Update the authorization path in Supabase Dashboard if needed to point to `https://coach.helix.toto-castaldi.com/oauth/consent` |
| **Claude Desktop MCP config** | Headers/URL | No change needed - points to Supabase Edge Functions |

  </how-to-verify>
  <resume-signal>Type "approved" when all three domains are working with HTTPS and auth, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
- `config/nginx-helix-landing.conf` serves helix.toto-castaldi.com with root /var/www/helix-landing and landing.html
- `config/nginx-helix-coach.conf` serves coach.helix.toto-castaldi.com with root /var/www/helix and index.html
- `config/nginx-helix-live.conf` remains unchanged for live.helix.toto-castaldi.com
- `config/nginx-helix-web.conf` is deleted (replaced by the two new configs)
- All three domains accessible via HTTPS after user completes deployment runbook
- Google OAuth works on coach.helix.toto-castaldi.com
</verification>

<success_criteria>
- Three separate Nginx config files exist in config/ for landing, coach, and live
- User confirms all three domains serve their respective apps with HTTPS
- Google OAuth login works on the new coach subdomain
</success_criteria>

<output>
After completion, create `.planning/phases/14-domain-routing/14-01-SUMMARY.md`
</output>
