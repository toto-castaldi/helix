---
phase: 07-mcp-template-integration
plan: 02
type: execute
wave: 2
depends_on: ["01"]
files_modified:
  - supabase/functions/helix-mcp/index.ts
autonomous: true

must_haves:
  truths:
    - "Tool create_group_template creates a new template"
    - "Tool update_group_template updates template name"
    - "Tool delete_group_template blocks deletion if template is in use"
  artifacts:
    - path: "supabase/functions/helix-mcp/index.ts"
      provides: "Template CRUD tools"
      contains: "create_group_template"
  key_links:
    - from: "executeTool function"
      to: "group_templates table"
      via: "supabase mutations"
      pattern: 'case "create_group_template"'
---

<objective>
Add MCP template CRUD tools to helix-mcp Edge Function.

Purpose: Enable AI clients to create, update, and delete group templates.
Output: Three CRUD tools (create, update, delete) functional in helix-mcp.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mcp-template-integration/07-RESEARCH.md
@.planning/phases/07-mcp-template-integration/07-01-SUMMARY.md
@supabase/functions/helix-mcp/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add template CRUD tool definitions</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Add three new tool definitions to `getToolDefinitions()` function, after `create_training_plan`. Group them together with a comment:

```typescript
// ===== GROUP TEMPLATE TOOLS =====
{
  name: "create_group_template",
  description: "Crea un nuovo template di gruppo",
  inputSchema: {
    type: "object",
    properties: {
      name: { type: "string", description: "Nome del template" },
    },
    required: ["name"],
  },
},
{
  name: "update_group_template",
  description: "Modifica il nome di un template esistente",
  inputSchema: {
    type: "object",
    properties: {
      template_id: { type: "string", description: "ID del template" },
      name: { type: "string", description: "Nuovo nome del template" },
    },
    required: ["template_id", "name"],
  },
},
{
  name: "delete_group_template",
  description: "Elimina un template (fallisce se in uso in sessioni)",
  inputSchema: {
    type: "object",
    properties: {
      template_id: { type: "string", description: "ID del template da eliminare" },
    },
    required: ["template_id"],
  },
},
```
  </action>
  <verify>
Read the file and confirm all 3 CRUD tool definitions are present with correct inputSchema.
  </verify>
  <done>
Three template CRUD tool definitions added to getToolDefinitions() with proper schemas and descriptions in Italian.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement template CRUD tool handlers</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Add handlers for create, update, delete tools in `executeTool()` switch statement, after `create_training_plan` case:

```typescript
// ===== GROUP TEMPLATE TOOLS =====
case "create_group_template": {
  const { name } = args as { name: string }

  const { data, error } = await supabase
    .from("group_templates")
    .insert({ name, user_id: userId })
    .select("id")
    .single()

  if (error) {
    return { content: [{ type: "text", text: `Errore: ${error.message}` }] }
  }

  return { content: [{ type: "text", text: `Template "${name}" creato con successo. ID: ${data.id}` }] }
}

case "update_group_template": {
  const { template_id, name } = args as { template_id: string; name: string }

  // Verify ownership
  const { data: existing, error: checkErr } = await supabase
    .from("group_templates")
    .select("id")
    .eq("id", template_id)
    .eq("user_id", userId)
    .single()

  if (checkErr || !existing) {
    return { content: [{ type: "text", text: "Errore: Template non trovato o non autorizzato" }] }
  }

  const { error } = await supabase
    .from("group_templates")
    .update({ name })
    .eq("id", template_id)

  if (error) {
    return { content: [{ type: "text", text: `Errore: ${error.message}` }] }
  }

  return { content: [{ type: "text", text: `Template "${name}" aggiornato con successo.` }] }
}

case "delete_group_template": {
  const { template_id } = args as { template_id: string }

  // Verify ownership
  const { data: existing, error: checkErr } = await supabase
    .from("group_templates")
    .select("id")
    .eq("id", template_id)
    .eq("user_id", userId)
    .single()

  if (checkErr || !existing) {
    return { content: [{ type: "text", text: "Errore: Template non trovato o non autorizzato" }] }
  }

  // Check if template is in use (canDeleteTemplate pattern)
  const { count, error: countErr } = await supabase
    .from("session_exercises")
    .select("id", { count: "exact", head: true })
    .eq("template_id", template_id)

  if (countErr) {
    return { content: [{ type: "text", text: `Errore: ${countErr.message}` }] }
  }

  if ((count ?? 0) > 0) {
    return { content: [{ type: "text", text: "Errore: Impossibile eliminare il template perche' e' utilizzato in una o piu' sessioni" }] }
  }

  const { error } = await supabase
    .from("group_templates")
    .delete()
    .eq("id", template_id)

  if (error) {
    return { content: [{ type: "text", text: `Errore: ${error.message}` }] }
  }

  return { content: [{ type: "text", text: `Template eliminato con successo.` }] }
}
```

Key points:
- Always verify ownership before operations
- delete checks canDeleteTemplate pattern (count session_exercises with template_id)
- Error messages in Italian, matching existing style
- Use accented "e'" instead of "Ã¨" for ASCII compatibility
  </action>
  <verify>
Test create_group_template with curl:
```bash
curl -s -X POST http://127.0.0.1:54321/functions/v1/helix-mcp \
  -H "Content-Type: application/json" \
  -H "X-Helix-API-Key: $TEST_API_KEY" \
  -d '{"jsonrpc": "2.0", "method": "tools/call", "id": 1, "params": {"name": "create_group_template", "arguments": {"name": "Test Template"}}}'
```
Should return success with template ID.
  </verify>
  <done>
create_group_template, update_group_template, delete_group_template handlers implemented with ownership verification and canDelete check.
  </done>
</task>

</tasks>

<verification>
1. Run `tools/list` and confirm 3 new CRUD tools appear (total should be 21)
2. Test create_group_template returns new template ID
3. Test delete_group_template blocks deletion if in use
4. Test update_group_template updates name correctly
5. TypeScript compiles without errors
</verification>

<success_criteria>
- [ ] All 3 template CRUD tool definitions in getToolDefinitions()
- [ ] All 3 template CRUD tool handlers in executeTool()
- [ ] create_group_template returns new template ID
- [ ] update_group_template changes template name
- [ ] delete_group_template blocks deletion if in use
- [ ] Error messages in Italian
</success_criteria>

<output>
After completion, create `.planning/phases/07-mcp-template-integration/07-02-SUMMARY.md`
</output>
