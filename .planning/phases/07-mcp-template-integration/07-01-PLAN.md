---
phase: 07-mcp-template-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/helix-mcp/index.ts
autonomous: true

must_haves:
  truths:
    - "Resource helix://group-templates returns list of coach's templates with preview"
    - "Resource helix://group-templates/{id} returns full template with exercises"
    - "Resources are listed in resources/list response"
    - "Resources respect RLS (coach can only see own templates)"
  artifacts:
    - path: "supabase/functions/helix-mcp/index.ts"
      provides: "Template resource handlers"
      contains: "helix://group-templates"
  key_links:
    - from: "readResource function"
      to: "group_templates table"
      via: "supabase query with user_id filter"
      pattern: 'from\\("group_templates"\\)'
---

<objective>
Add MCP resources for group templates to helix-mcp Edge Function.

Purpose: Enable AI clients (Claude Desktop, Cursor) to read template data for planning sessions.
Output: Two new resources registered and functional in helix-mcp.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-mcp-template-integration/07-RESEARCH.md
@supabase/functions/helix-mcp/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add template resource definitions</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Add two new resource definitions to `getResourceTemplates()` function:

1. Template list resource:
```typescript
{ uri: "helix://group-templates", name: "group-templates-list", description: "Lista template gruppi", mimeType: "application/json" },
```

2. Template detail resource (with URI template):
```typescript
{ uriTemplate: "helix://group-templates/{templateId}", name: "group-template-detail", description: "Dettaglio template gruppo con esercizi", mimeType: "application/json" },
```

Add these after the existing session resources, keeping alphabetical grouping (clients, exercises, gyms, sessions, then templates).
  </action>
  <verify>
Read the file and confirm the two new resources are in getResourceTemplates() array.
  </verify>
  <done>
Two template resources defined in getResourceTemplates() with correct uri, name, description, mimeType.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement template list resource handler</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Add handler for `helix://group-templates` in the `readResource()` function, after the session handlers and before coach/summary.

Implementation following research code example:
```typescript
// helix://group-templates
if (uri === "helix://group-templates") {
  const { data, error } = await supabase
    .from("group_templates")
    .select(`
      id, name, created_at, updated_at,
      exercises:group_template_exercises(
        id,
        exercise:exercises(id, name)
      )
    `)
    .eq("user_id", userId)
    .order("name")

  if (error) throw new Error(error.message)

  // Transform for preview: count + first 3 exercise names
  const templatesWithPreview = (data || []).map(t => ({
    id: t.id,
    name: t.name,
    exercise_count: t.exercises?.length || 0,
    exercise_preview: t.exercises?.slice(0, 3).map(e => e.exercise?.name).filter(Boolean) || [],
    created_at: t.created_at,
    updated_at: t.updated_at,
  }))

  return [{ uri, mimeType: "application/json", text: JSON.stringify(templatesWithPreview, null, 2) }]
}
```

Key points:
- Filter by user_id for RLS compliance
- Order by name for consistent listing
- Include exercise count and first 3 exercise names as preview
- Return empty array if no templates (not error)
  </action>
  <verify>
Start local Supabase functions (`npx supabase functions serve --env-file supabase/.env`) and test with curl:
```bash
curl -s -X POST http://127.0.0.1:54321/functions/v1/helix-mcp \
  -H "Content-Type: application/json" \
  -H "X-Helix-API-Key: $TEST_API_KEY" \
  -d '{"jsonrpc": "2.0", "method": "resources/read", "id": 1, "params": {"uri": "helix://group-templates"}}'
```
Should return JSON with templates array (may be empty if no templates exist).
  </verify>
  <done>
`helix://group-templates` returns list with id, name, exercise_count, exercise_preview, created_at, updated_at.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement template detail resource handler</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Add handler for `helix://group-templates/{id}` in the `readResource()` function, right after the list handler.

Implementation following research code example:
```typescript
// helix://group-templates/{id}
const templateDetailMatch = uri.match(/^helix:\/\/group-templates\/([^\/]+)$/)
if (templateDetailMatch) {
  const templateId = templateDetailMatch[1]
  const { data, error } = await supabase
    .from("group_templates")
    .select(`
      *,
      exercises:group_template_exercises(
        *,
        exercise:exercises(
          id, name, description, lumio_card_id,
          exercise_tags(tag)
        )
      )
    `)
    .eq("id", templateId)
    .eq("user_id", userId)
    .single()

  if (error) throw new Error(`Template non trovato: ${templateId}`)

  // Sort exercises by order_index
  if (data.exercises) {
    data.exercises.sort((a, b) => a.order_index - b.order_index)
  }

  return [{ uri, mimeType: "application/json", text: JSON.stringify(data, null, 2) }]
}
```

Key points:
- Filter by BOTH id AND user_id (security: prevent accessing other coaches' templates)
- Use .single() for detail endpoint
- Include full exercise data: id, name, description, lumio_card_id, tags
- Sort exercises by order_index
- Error message in Italian to match existing code style
  </action>
  <verify>
Test with curl (requires a template ID from local database):
```bash
curl -s -X POST http://127.0.0.1:54321/functions/v1/helix-mcp \
  -H "Content-Type: application/json" \
  -H "X-Helix-API-Key: $TEST_API_KEY" \
  -d '{"jsonrpc": "2.0", "method": "resources/read", "id": 1, "params": {"uri": "helix://group-templates/TEMPLATE_ID"}}'
```
Should return full template with exercises array, or error if not found.
  </verify>
  <done>
`helix://group-templates/{id}` returns full template with exercises sorted by order_index, including exercise details (name, description, lumio_card_id, tags).
  </done>
</task>

</tasks>

<verification>
1. Run `resources/list` and confirm both new resources appear (total should be 19)
2. Test `helix://group-templates` returns empty array or list of templates
3. Test `helix://group-templates/{id}` returns template detail or error for invalid ID
4. Confirm error messages are in Italian
5. TypeScript compiles without errors
</verification>

<success_criteria>
- [ ] `getResourceTemplates()` includes both new template resources
- [ ] `helix://group-templates` returns list with preview (exercise_count, exercise_preview)
- [ ] `helix://group-templates/{id}` returns full template with exercises
- [ ] Exercises are sorted by order_index in detail response
- [ ] Resources filter by user_id (RLS compliance)
- [ ] Error messages in Italian (matching existing style)
</success_criteria>

<output>
After completion, create `.planning/phases/07-mcp-template-integration/07-01-SUMMARY.md`
</output>
