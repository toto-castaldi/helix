---
phase: 09-mobile-cleanup-bugfix
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/client-export/index.ts
  - src/pages/ClientDetail.tsx
autonomous: false

must_haves:
  truths:
    - "Client export works without showing error"
    - "Exported markdown file contains client information"
    - "Exported markdown file downloads as .md"
  artifacts:
    - path: "supabase/functions/client-export/index.ts"
      provides: "Edge Function generating client markdown export"
      exports: ["default"]
      min_lines: 50
    - path: "src/pages/ClientDetail.tsx"
      provides: "Client detail page with working export button"
      contains: "Scheda cliente"
  key_links:
    - from: "src/pages/ClientDetail.tsx"
      to: "supabase/functions/client-export/index.ts"
      via: "fetch call to Edge Function"
      pattern: "functions/v1/client-export"
---

<objective>
Fix the client export feature that currently shows an error when attempting to export a client card.

Purpose: Coaches need to export client information as markdown for offline use or sharing.
Output: Working export that downloads a .md file with client data.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-mobile-cleanup-bugfix/09-CONTEXT.md
@src/pages/ClientDetail.tsx
@supabase/functions/client-export/index.ts
</context>

<tasks>

<task type="checkpoint:investigation">
  <name>Task 1: Investigate the export bug</name>
  <files>
    src/pages/ClientDetail.tsx
    supabase/functions/client-export/index.ts
  </files>
  <action>
Investigate the bug by testing locally:

1. Start local Supabase: `npm run supabase:start`
2. Start Edge Functions: `npx supabase functions serve --env-file supabase/.env`
3. Start frontend: `npm run dev`
4. Navigate to a client detail page
5. Click "Scheda cliente" button
6. Observe the error in:
   - Browser console (Network tab, Console tab)
   - Edge Function logs in terminal
   - Any alert message shown to user

Document the exact error message and stack trace.

Common potential issues to check:
- JWT/Auth token not being passed correctly
- RLS blocking access to related tables (exercises, gyms)
- Missing CORS headers
- Relation query failing due to deleted exercises
- JSON parsing errors on response
  </action>
  <verify>
    - Error message and root cause identified
    - Stack trace or error logs captured
  </verify>
  <done>
    - Root cause of export bug documented
    - Fix approach determined
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply the fix to resolve export error</name>
  <files>
    supabase/functions/client-export/index.ts
    src/pages/ClientDetail.tsx
  </files>
  <action>
Based on investigation results from Task 1, apply the appropriate fix.

The fix will depend on the root cause found. Possible fixes:
- If auth issue: Ensure Authorization header is passed correctly in fetch call
- If RLS issue: Update Edge Function to use service_role key for queries
- If CORS issue: Add proper CORS headers to Edge Function response
- If query issue: Fix the Supabase query syntax or handle null relations
- If response issue: Ensure proper JSON response format and content-type

Apply the minimal change needed to fix the identified issue.
  </action>
  <verify>
    - Modified file(s) contain the fix
    - No syntax errors in TypeScript
  </verify>
  <done>
    - Fix applied to appropriate file(s)
    - Code compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Test the fix works end-to-end</name>
  <files>
    src/pages/ClientDetail.tsx
    supabase/functions/client-export/index.ts
  </files>
  <action>
Test the fix by repeating the export flow:

1. Ensure local services are running (Supabase, Edge Functions, frontend)
2. Navigate to a client detail page
3. Click "Scheda cliente" button
4. Verify:
   - No error message appears
   - A .md file downloads
   - The markdown contains correct client info (name, goals, sessions, exercises)
  </action>
  <verify>
    - Export completes without error
    - Downloaded file is valid markdown
    - Client information is present in export
  </verify>
  <done>
    - Export flow works end-to-end
    - Markdown file contains expected client data
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify build succeeds</name>
  <files>package.json</files>
  <action>
Run the build to ensure no regressions:
```bash
npm run build
```
Must succeed without errors.
  </action>
  <verify>
    - npm run build exits with code 0
  </verify>
  <done>
    - Main app builds successfully
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

```bash
# Build succeeds
npm run build

# Edge Function file is valid TypeScript
npx supabase functions lint client-export

# Manual verification: Export works without errors (verified during Task 3)
```
</verification>

<success_criteria>
- Client export works without showing error
- Exported markdown file contains client information (name, goals, sessions, exercises)
- Exported markdown file downloads correctly as .md
- Main app builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/09-mobile-cleanup-bugfix/09-02-SUMMARY.md`
</output>
