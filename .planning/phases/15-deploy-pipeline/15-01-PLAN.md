---
phase: 15-deploy-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/deploy.yml]
autonomous: true
requirements: [INFRA-01, INFRA-02]

must_haves:
  truths:
    - "GitHub Actions workflow builds landing, coach, and live apps in a single pipeline run"
    - "Landing build output (dist-landing/) is deployed to /var/www/helix-landing via DEPLOY_PATH_LANDING secret"
    - "Coach and live app deploys continue to work unchanged"
    - "Nginx config files from config/ are synced to the server and Nginx is reloaded"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Three-app build and deploy pipeline with Nginx config sync"
      contains: "build:landing"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "dist-landing/"
      via: "npm run build:landing step"
      pattern: "build:landing"
    - from: ".github/workflows/deploy.yml"
      to: "DEPLOY_PATH_LANDING secret"
      via: "ssh-deploy action"
      pattern: "DEPLOY_PATH_LANDING"
---

<objective>
Update the GitHub Actions deploy workflow to build and deploy all three Helix apps (landing, coach, live) and sync Nginx configuration files to the server.

Purpose: The current pipeline only builds and deploys the coach and live apps. The landing page (introduced in Phases 12-13) and the new Nginx configs (from Phase 14) need to be included in the automated CI/CD pipeline so every push to main deploys the full system.

Output: Updated `.github/workflows/deploy.yml` with landing build step, landing deploy step, and Nginx config sync.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-domain-routing/14-01-SUMMARY.md
@.github/workflows/deploy.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add landing build step and three-app deploy with Nginx sync to deploy.yml</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Edit `.github/workflows/deploy.yml` to add the following changes:

1. **Add "Build landing app" step** after the existing "Build live app" step:
   ```yaml
   - name: Build landing app
     run: npm run build:landing
     env:
       VITE_APP_VERSION: ${{ steps.version.outputs.version }}
   ```
   Note: Landing page does NOT need VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY (it is a static vanilla JS page with no Supabase dependency).

2. **Add "Deploy landing app to server" step** after the existing "Deploy live app to server" step:
   ```yaml
   - name: Deploy landing app to server
     uses: easingthemes/ssh-deploy@v5.1.0
     with:
       SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
       REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
       REMOTE_USER: ${{ secrets.REMOTE_USER }}
       SOURCE: dist-landing/
       TARGET: ${{ secrets.DEPLOY_PATH_LANDING }}
       ARGS: "-avz --delete"
   ```
   This requires the user to add `DEPLOY_PATH_LANDING` as a GitHub Actions secret (value: `/var/www/helix-landing`).

3. **Add "Sync Nginx configs and reload" step** after all deploy steps but before the Supabase section. Use an SSH command step to copy the three config files and reload Nginx:
   ```yaml
   - name: Sync Nginx configs and reload
     uses: appleboy/ssh-action@v1
     with:
       host: ${{ secrets.REMOTE_HOST }}
       username: ${{ secrets.REMOTE_USER }}
       key: ${{ secrets.SSH_PRIVATE_KEY }}
       script: |
         # Sync Nginx configs from deploy path
         sudo cp ${{ secrets.DEPLOY_PATH }}/config/nginx-helix-coach.conf /etc/nginx/sites-available/nginx-helix-coach.conf
         sudo cp ${{ secrets.DEPLOY_PATH_LANDING }}/config/nginx-helix-landing.conf /etc/nginx/sites-available/nginx-helix-landing.conf
         sudo nginx -t && sudo systemctl reload nginx
   ```

   Wait -- this approach has a problem: the config/ directory is in the source repo but NOT in the build output (dist/). We need to deploy the config files separately.

   **Better approach:** Add a dedicated deploy step that copies config files to a known location, OR include config/ in the rsync of one of the apps. The simplest approach: deploy the config/ directory alongside the coach app since it already deploys to /var/www/helix.

   Actually, the cleanest approach: use the ssh-action to transfer and apply configs directly from the checkout. Add this step:

   ```yaml
   - name: Deploy Nginx configs
     uses: appleboy/ssh-action@v1
     with:
       host: ${{ secrets.REMOTE_HOST }}
       username: ${{ secrets.REMOTE_USER }}
       key: ${{ secrets.SSH_PRIVATE_KEY }}
       script_stop: true
       script: "echo 'Nginx config sync placeholder'"
   ```

   Hmm, that won't work either because ssh-action runs commands on the remote but doesn't transfer files.

   **Final approach:** Use the easingthemes/ssh-deploy action to sync the config/ directory to a known path on the server, then use ssh-action to copy configs to Nginx sites-available and reload:

   ```yaml
   - name: Deploy Nginx configs to server
     uses: easingthemes/ssh-deploy@v5.1.0
     with:
       SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
       REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
       REMOTE_USER: ${{ secrets.REMOTE_USER }}
       SOURCE: config/
       TARGET: /tmp/helix-nginx-config/
       ARGS: "-avz --delete"

   - name: Apply Nginx configs and reload
     uses: appleboy/ssh-action@v1
     with:
       host: ${{ secrets.REMOTE_HOST }}
       username: ${{ secrets.REMOTE_USER }}
       key: ${{ secrets.SSH_PRIVATE_KEY }}
       script_stop: true
       script: |
         sudo cp /tmp/helix-nginx-config/nginx-helix-landing.conf /etc/nginx/sites-available/
         sudo cp /tmp/helix-nginx-config/nginx-helix-coach.conf /etc/nginx/sites-available/
         sudo nginx -t && sudo systemctl reload nginx
         rm -rf /tmp/helix-nginx-config
   ```

   This keeps the live.conf managed separately (it was deployed before Phase 14 and is not in the source repo's config/ with a full SSL block).

   **Important:** Do NOT copy the live config because it uses `...` placeholder for SSL in source (see nginx-helix-live.conf) â€” it would break the live site. Only sync landing and coach configs.

Order of all steps in the final workflow:
1. Checkout
2. Generate version
3. Update README with version
4. Commit version update
5. Setup Node.js
6. Install dependencies
7. Build main app (coach)
8. Build live app
9. Build landing app (NEW)
10. Deploy main app (coach)
11. Deploy live app
12. Deploy landing app (NEW)
13. Deploy Nginx configs (NEW)
14. Apply Nginx configs and reload (NEW)
15. Setup Supabase CLI
16. Link Supabase
17. Backup Database
18. Upload Backup Artifact
19. Run Database Migrations
20. Deploy Edge Functions
  </action>
  <verify>
Run: `cat .github/workflows/deploy.yml` and confirm:
- "Build landing app" step exists with `npm run build:landing`
- "Deploy landing app to server" step exists with `DEPLOY_PATH_LANDING` secret
- "Deploy Nginx configs to server" step exists targeting /tmp/helix-nginx-config/
- "Apply Nginx configs and reload" step exists with `nginx -t && systemctl reload nginx`
- Existing steps for coach and live builds/deploys are unchanged
- Landing build does NOT reference VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY
  </verify>
  <done>
deploy.yml contains build+deploy steps for all three apps (coach, live, landing) plus Nginx config sync with reload, and all existing steps remain unchanged.
  </done>
</task>

</tasks>

<verification>
1. Verify deploy.yml is valid YAML: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"`
2. Confirm "Build landing app" step exists
3. Confirm "Deploy landing app" step uses DEPLOY_PATH_LANDING secret
4. Confirm Nginx config deploy and reload steps exist
5. Confirm existing coach/live build and deploy steps are unchanged
6. Confirm the landing build step does NOT include Supabase env vars
</verification>

<success_criteria>
- deploy.yml builds landing, coach, and live in one pipeline
- Landing build deploys to DEPLOY_PATH_LANDING
- Nginx configs are synced and Nginx is reloaded
- Existing pipeline behavior for coach, live, Supabase, and Edge Functions is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/15-deploy-pipeline/15-01-SUMMARY.md`
</output>
