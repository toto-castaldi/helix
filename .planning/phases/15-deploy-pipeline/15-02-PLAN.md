---
phase: 15-deploy-pipeline
plan: 02
type: execute
wave: 2
depends_on: [15-01]
files_modified: []
autonomous: false
requirements: [INFRA-01, INFRA-02, INFRA-03]

user_setup:
  - service: GitHub Actions
    why: "Landing app deploy path secret required for new pipeline step"
    env_vars:
      - name: DEPLOY_PATH_LANDING
        source: "GitHub repo Settings > Secrets and variables > Actions > New repository secret, value: /var/www/helix-landing"

must_haves:
  truths:
    - "A push to main builds and deploys all three apps without manual intervention"
    - "helix.toto-castaldi.com serves the landing page with valid HTTPS"
    - "coach.helix.toto-castaldi.com serves the coach app with valid HTTPS"
    - "live.helix.toto-castaldi.com serves the live tablet app with valid HTTPS"
  artifacts: []
  key_links:
    - from: "GitHub Actions workflow"
      to: "/var/www/helix-landing"
      via: "DEPLOY_PATH_LANDING secret"
      pattern: "DEPLOY_PATH_LANDING"
---

<objective>
User provisions server prerequisites (sudo access, directories, certbot SSL certificates, GitHub secret), triggers a deploy, and verifies all three domains work correctly over HTTPS.

Purpose: The pipeline update from Plan 15-01 requires server setup (directory creation, SSL certificates, GitHub secret) and end-to-end verification that all three apps build, deploy, and serve correctly over HTTPS.

Output: All three Helix domains serving current content via automated pipeline with valid HTTPS.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-deploy-pipeline/15-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Server prerequisites, certbot SSL provisioning, GitHub secret, and full pipeline verification</name>
  <files>N/A - Server SSH + GitHub UI actions</files>
  <action>
The user must complete server prerequisites, provision SSL certificates, add the GitHub secret, and then verify the complete pipeline works.

**Step 1: Verify server prerequisites (SSH to server)**

SSH into the server and verify the deploy user has the required sudo permissions:

```bash
# Test that REMOTE_USER can run Nginx operations with sudo
sudo nginx -t
sudo systemctl reload nginx
sudo cp /dev/null /tmp/test-sudo-cp && rm /tmp/test-sudo-cp
sudo ln -sf /dev/null /tmp/test-sudo-ln && rm /tmp/test-sudo-ln
```

If any command fails with "permission denied" or prompts for a password, configure passwordless sudo for the deploy user:
```bash
# As root or a user with full sudo:
echo "REMOTE_USER ALL=(ALL) NOPASSWD: /usr/bin/nginx, /usr/sbin/nginx, /bin/systemctl reload nginx, /bin/cp, /bin/ln, /bin/sed" | sudo tee /etc/sudoers.d/helix-deploy
sudo chmod 440 /etc/sudoers.d/helix-deploy
sudo visudo -c  # Validate sudoers syntax
```
Replace `REMOTE_USER` with the actual username used in GitHub Actions.

**Step 2: Create landing directory on server**

```bash
sudo mkdir -p /var/www/helix-landing
sudo chown $(whoami):$(whoami) /var/www/helix-landing
```

**Step 3: Add DEPLOY_PATH_LANDING GitHub secret**

1. Go to GitHub repository Settings > Secrets and variables > Actions
2. Click "New repository secret"
3. Name: `DEPLOY_PATH_LANDING`
4. Value: `/var/www/helix-landing`
5. Click "Add secret"

**Step 4: Run first deploy (HTTP-only)**

1. Push to main (the plan execution commit will trigger it, or push manually)
2. Go to GitHub Actions tab and watch the workflow run
3. Verify ALL steps complete successfully, especially:
   - "Build landing app" step passes
   - "Deploy landing app to server" step passes
   - "Deploy Nginx configs to server" step passes
   - "Apply Nginx configs and reload" step passes (should log "SSL cert not found" and disable 443 blocks)
   - All existing steps (coach build/deploy, live build/deploy, Supabase) pass
4. Verify HTTP access works:
   - Visit http://helix.toto-castaldi.com — should show the landing page (HTTP, no HTTPS yet)
   - Visit http://coach.helix.toto-castaldi.com — should show the coach app (HTTP, no HTTPS yet)
   - Visit https://live.helix.toto-castaldi.com — should still work (managed separately)

**Step 5: Provision SSL certificates with certbot (INFRA-03)**

SSH into the server and run certbot for the two new domains:

```bash
# Install certbot if not already installed
sudo apt-get update && sudo apt-get install -y certbot python3-certbot-nginx

# Provision SSL for landing domain
sudo certbot --nginx -d helix.toto-castaldi.com

# Provision SSL for coach domain
sudo certbot --nginx -d coach.helix.toto-castaldi.com
```

Certbot will:
1. Obtain Let's Encrypt certificates
2. Modify the Nginx configs in `/etc/nginx/sites-available/` to add SSL directives
3. Reload Nginx automatically

**Important:** Certbot modifies the Nginx config files on the server directly. On the NEXT pipeline deploy, the "Apply Nginx configs" step will overwrite these files with the source versions, but since certs now exist, it will uncomment the SSL lines from the source config and everything will work.

Verify certbot succeeded:
```bash
sudo certbot certificates
# Should show certificates for helix.toto-castaldi.com and coach.helix.toto-castaldi.com

sudo nginx -t
# Should pass

# Verify auto-renewal is set up
sudo certbot renew --dry-run
```

**Step 6: Trigger second deploy and verify HTTPS**

1. Push another commit to main (or re-run the workflow)
2. Watch the workflow — the "Apply Nginx configs" step should now log "SSL cert found" and uncomment SSL lines
3. After the workflow completes, verify all three domains with HTTPS:
   - Visit https://helix.toto-castaldi.com — should show the landing page with valid HTTPS
   - Visit https://coach.helix.toto-castaldi.com — should show the coach app login with valid HTTPS
   - Visit https://live.helix.toto-castaldi.com — should show the live tablet app with valid HTTPS
4. Verify HTTP redirects to HTTPS:
   - Visit http://helix.toto-castaldi.com — should redirect to https://
   - Visit http://coach.helix.toto-castaldi.com — should redirect to https://
5. Verify HTTPS certificates are valid on all three domains (no browser warnings)
  </action>
  <verify>
All three domains serve correct content over HTTPS after automated pipeline run:
- https://helix.toto-castaldi.com shows landing page
- https://coach.helix.toto-castaldi.com shows coach app
- https://live.helix.toto-castaldi.com shows live tablet app
- HTTP requests redirect to HTTPS for all domains
- `sudo certbot certificates` shows valid certs for both new domains
  </verify>
  <done>
Push to main deploys landing, coach, and live apps automatically; all three domains accessible with valid HTTPS; certbot auto-renewal configured for new domains.
  </done>
</task>

</tasks>

<verification>
1. GitHub Actions workflow run completes without errors
2. All three domains serve their correct content over HTTPS
3. HTTP requests redirect to HTTPS on all three domains
4. SSL certificates are valid and auto-renewal is configured
5. No manual file copying or server SSH needed after the initial certbot setup
</verification>

<success_criteria>
- Push to main deploys all three apps automatically
- helix.toto-castaldi.com serves landing page over HTTPS
- coach.helix.toto-castaldi.com serves coach app over HTTPS
- live.helix.toto-castaldi.com serves live tablet app over HTTPS
- All domains have valid HTTPS certificates with auto-renewal
- Server deploy user has required sudo permissions for Nginx operations
</success_criteria>

<output>
After completion, create `.planning/phases/15-deploy-pipeline/15-02-SUMMARY.md`
</output>
