---
phase: 06-template-management-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000020_session_template_link.sql
  - src/shared/types/index.ts
  - src/hooks/useGroupTemplates.ts
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "template_id column exists on session_exercises table"
    - "useGroupTemplates hook can fetch all templates with exercises"
    - "useGroupTemplates hook can create, update, delete templates"
    - "useGroupTemplates hook can add, update, remove, reorder template exercises"
    - "Deleting a template used by sessions is blocked with clear error"
  artifacts:
    - path: "supabase/migrations/00000000000020_session_template_link.sql"
      provides: "template_id FK on session_exercises"
      contains: "ALTER TABLE public.session_exercises"
    - path: "src/hooks/useGroupTemplates.ts"
      provides: "Template CRUD operations"
      exports: ["useGroupTemplates"]
    - path: "src/shared/types/index.ts"
      provides: "Updated SessionExercise with template_id"
      contains: "template_id"
  key_links:
    - from: "src/hooks/useGroupTemplates.ts"
      to: "supabase"
      via: "Supabase client queries"
      pattern: "supabase\\.from\\('group_templates'\\)"
---

<objective>
Create the data layer for template management: database migration for linked templates, useGroupTemplates hook, and TypeScript type updates.

Purpose: Enable template CRUD operations and linked template behavior (session exercises reference templates)
Output: Migration file, hook with full CRUD for templates and exercises, updated types
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-template-database-schema/05-01-SUMMARY.md
@.planning/phases/06-template-management-ui/06-CONTEXT.md
@.planning/phases/06-template-management-ui/06-RESEARCH.md

Key patterns to follow:
@src/hooks/useGyms.ts (CRUD hook pattern)
@src/hooks/useSessions.ts (nested exercises pattern)
@src/shared/types/index.ts (TypeScript types)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add template_id migration</name>
  <files>supabase/migrations/00000000000020_session_template_link.sql</files>
  <action>
Create migration to add template_id column to session_exercises table.

The column enables "linked template" behavior per CONTEXT.md:
- Session exercises from a template reference the template
- Editing blocked in session view (coach edits template instead)
- Template deletion blocked if any session uses it (ON DELETE RESTRICT)

Migration content:
```sql
-- Add template_id to session_exercises for linked template behavior
-- Exercises from a template reference the template, enabling:
-- 1. Blocking edit in session view (coach edits template instead)
-- 2. Block template deletion if any session uses it

ALTER TABLE public.session_exercises
ADD COLUMN template_id uuid REFERENCES public.group_templates(id) ON DELETE RESTRICT;

-- Partial index for finding sessions using a template (only non-null values)
CREATE INDEX session_exercises_template_id_idx
  ON public.session_exercises(template_id)
  WHERE template_id IS NOT NULL;

-- Note: No RLS changes needed - session_exercises already has RLS
-- template_id is nullable - non-template exercises remain as-is
```
  </action>
  <verify>
Run migration locally and verify column exists:
```bash
npm run supabase:reset
PGPASSWORD=postgres psql -h 127.0.0.1 -p 54322 -U postgres -d postgres -c "\d public.session_exercises" | grep template_id
```
  </verify>
  <done>session_exercises table has template_id uuid column with FK to group_templates</done>
</task>

<task type="auto">
  <name>Task 2: Update SessionExercise types</name>
  <files>src/shared/types/index.ts</files>
  <action>
Update SessionExercise interface and related types to include template_id.

In `src/shared/types/index.ts`:

1. Add `template_id: string | null` to `SessionExercise` interface (after `is_group: boolean`)

2. Add `template_id?: string | null` to `SessionExerciseInsert` interface (after `is_group?: boolean`)

3. No change needed to `SessionExerciseUpdate` - it already extends Partial of the insert type

This enables TypeScript to recognize template-linked exercises.
  </action>
  <verify>
```bash
cd /home/toto/scm-projects/helix && npm run build 2>&1 | grep -i "error" || echo "Build OK"
```
  </verify>
  <done>SessionExercise and SessionExerciseInsert interfaces include template_id field</done>
</task>

<task type="auto">
  <name>Task 3: Create useGroupTemplates hook</name>
  <files>src/hooks/useGroupTemplates.ts</files>
  <action>
Create hook following useGyms pattern with additions from useSessions for nested exercises.

The hook must provide:

**State:**
- `templates: GroupTemplateWithExercises[]`
- `loading: boolean`
- `error: string | null`

**Template CRUD:**
- `fetchTemplates()` - fetch all with nested exercises, sorted by name
- `createTemplate(data: GroupTemplateInsert)` - insert and return new template
- `updateTemplate(id, data: GroupTemplateUpdate)` - update name
- `deleteTemplate(id)` - check if in use first, return false with error if used
- `getTemplate(id)` - fetch single template with exercises

**Template Exercise CRUD:**
- `addExercise(data: GroupTemplateExerciseInsert)` - auto-assign order_index
- `updateExercise(id, data: GroupTemplateExerciseUpdate)` - update params
- `removeExercise(id)` - delete from template
- `reorderExercises(templateId, exerciseIds[])` - update order_index for each

**Delete check function:**
```typescript
const canDeleteTemplate = async (templateId: string): Promise<boolean> => {
  const { count } = await supabase
    .from('session_exercises')
    .select('id', { count: 'exact', head: true })
    .eq('template_id', templateId)
  return count === 0
}
```

**Query pattern for fetch with exercises:**
```typescript
supabase
  .from('group_templates')
  .select(`
    *,
    exercises:group_template_exercises(
      *,
      exercise:exercises(*)
    )
  `)
  .order('name', { ascending: true })
```

Sort exercises by order_index after fetch (like useSessions does).

Use types from `@/types`:
- GroupTemplate, GroupTemplateInsert, GroupTemplateUpdate
- GroupTemplateWithExercises
- GroupTemplateExercise, GroupTemplateExerciseInsert, GroupTemplateExerciseUpdate
- GroupTemplateExerciseWithDetails
  </action>
  <verify>
```bash
cd /home/toto/scm-projects/helix && npm run build 2>&1 | grep -i "error" || echo "Build OK"
```
  </verify>
  <done>useGroupTemplates hook exports all CRUD operations for templates and their exercises</done>
</task>

<task type="auto">
  <name>Task 4: Update CLAUDE.md Database section</name>
  <files>CLAUDE.md</files>
  <action>
Update CLAUDE.md Database section to document the new template_id column on session_exercises table.

In the Database section, find the `session_exercises` table entry and add `template_id` to its column list.

Current:
```
- `session_exercises` - Exercises in a session (exercise_id, order_index, sets, reps, weight_kg, duration_seconds, completed, completed_at, is_group)
```

Update to:
```
- `session_exercises` - Exercises in a session (exercise_id, order_index, sets, reps, weight_kg, duration_seconds, completed, completed_at, is_group, template_id)
```

This follows the project rule: "Update CLAUDE.md after migrations."
  </action>
  <verify>
```bash
grep "session_exercises.*template_id" /home/toto/scm-projects/helix/CLAUDE.md
```
  </verify>
  <done>CLAUDE.md Database section documents template_id column on session_exercises table</done>
</task>

</tasks>

<verification>
1. Migration runs without error: `npm run supabase:reset`
2. TypeScript compiles: `npm run build`
3. Verify template_id column exists in database
4. Verify hook file exports useGroupTemplates function
</verification>

<success_criteria>
- Migration 00000000000020 creates template_id column on session_exercises
- SessionExercise type includes template_id: string | null
- useGroupTemplates hook provides full CRUD for templates and exercises
- Hook includes canDeleteTemplate check before delete
- All files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-template-management-ui/06-01-SUMMARY.md`
</output>
