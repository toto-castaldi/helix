---
phase: 06-template-management-ui
plan: 03
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - src/components/templates/ApplyTemplateDialog.tsx
  - src/components/templates/index.ts
  - src/hooks/useGroupTemplates.ts
  - src/pages/SessionDetail.tsx
  - src/components/sessions/SessionExerciseCard.tsx
autonomous: false

must_haves:
  truths:
    - "Coach can apply a template to a session from SessionDetail page"
    - "When session has group exercises, coach chooses Add or Replace mode"
    - "Template exercises are linked (template_id set) when applied"
    - "Template-linked exercises cannot be edited in session view"
    - "Template-linked exercises show visual indicator"
  artifacts:
    - path: "src/components/templates/ApplyTemplateDialog.tsx"
      provides: "Template selection and apply mode dialog"
      min_lines: 50
    - path: "src/hooks/useGroupTemplates.ts"
      provides: "applyTemplateToSession function"
      contains: "applyTemplateToSession"
    - path: "src/components/sessions/SessionExerciseCard.tsx"
      provides: "Disabled editing for template exercises"
      contains: "template_id"
  key_links:
    - from: "src/pages/SessionDetail.tsx"
      to: "src/components/templates/ApplyTemplateDialog.tsx"
      via: "state toggle and import"
      pattern: "showApplyTemplate"
    - from: "src/components/templates/ApplyTemplateDialog.tsx"
      to: "src/hooks/useGroupTemplates.ts"
      via: "hook for template list and apply"
      pattern: "useGroupTemplates"
---

<objective>
Implement apply template to session functionality with linked behavior: exercises reference template and cannot be edited in session view.

Purpose: Coach can apply templates to sessions with proper linking and edit blocking
Output: ApplyTemplateDialog component, applyTemplateToSession function, edit blocking in SessionExerciseCard
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-template-management-ui/06-01-SUMMARY.md
@.planning/phases/06-template-management-ui/06-02-SUMMARY.md
@.planning/phases/06-template-management-ui/06-CONTEXT.md
@.planning/phases/06-template-management-ui/06-RESEARCH.md

Key files to modify:
@src/hooks/useGroupTemplates.ts (add applyTemplateToSession)
@src/pages/SessionDetail.tsx (add apply template button and dialog)
@src/components/sessions/SessionExerciseCard.tsx (block editing for template exercises)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add applyTemplateToSession to useGroupTemplates</name>
  <files>src/hooks/useGroupTemplates.ts</files>
  <action>
Add function to apply a template to a session.

Function signature:
```typescript
const applyTemplateToSession = async (
  sessionId: string,
  templateId: string,
  mode: 'add' | 'replace'
): Promise<boolean>
```

Implementation steps:

1. Fetch template with exercises (use getTemplate)

2. If mode is 'replace':
   - Delete existing group exercises from session:
   ```typescript
   await supabase
     .from('session_exercises')
     .delete()
     .eq('session_id', sessionId)
     .eq('is_group', true)
   ```

3. Get current max order_index for add mode:
   ```typescript
   const { data: existing } = await supabase
     .from('session_exercises')
     .select('order_index')
     .eq('session_id', sessionId)
     .order('order_index', { ascending: false })
     .limit(1)
   const startIndex = mode === 'add' ? ((existing?.[0]?.order_index ?? -1) + 1) : 0
   ```

4. Insert template exercises as session exercises with template_id link:
   ```typescript
   const exercisesToInsert = template.exercises.map((ex, idx) => ({
     session_id: sessionId,
     exercise_id: ex.exercise_id,
     template_id: templateId,  // CRITICAL: Link to template!
     order_index: startIndex + idx,
     sets: ex.sets,
     reps: ex.reps,
     weight_kg: ex.weight_kg,
     duration_seconds: ex.duration_seconds,
     notes: ex.notes,
     is_group: true,
     completed: false,
     skipped: false,
   }))

   const { error } = await supabase
     .from('session_exercises')
     .insert(exercisesToInsert)
   ```

5. Return true if no error, false otherwise (set error state if failed)

Export the function from hook return.
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -i "error" || echo "Build OK"
grep "applyTemplateToSession" /home/toto/scm-projects/helix/src/hooks/useGroupTemplates.ts
```
  </verify>
  <done>applyTemplateToSession function added to useGroupTemplates hook</done>
</task>

<task type="auto">
  <name>Task 2: Create ApplyTemplateDialog and integrate with SessionDetail</name>
  <files>
    src/components/templates/ApplyTemplateDialog.tsx
    src/components/templates/index.ts
    src/pages/SessionDetail.tsx
  </files>
  <action>
**src/components/templates/ApplyTemplateDialog.tsx:**
Dialog for selecting a template and choosing add/replace mode.

Structure:
- Full-page overlay (like ExercisePicker)
- List of templates to select from (TemplateCard style but clickable)
- When template selected:
  - If session has no group exercises: apply immediately
  - If session has group exercises: show mode selection

Mode selection UI:
```tsx
<div className="p-4 space-y-4">
  <p className="text-sm text-muted-foreground">
    La sessione ha gia esercizi di gruppo. Cosa vuoi fare?
  </p>
  <div className="flex gap-3">
    <Button onClick={() => onConfirm('add')}>
      <Plus className="h-4 w-4 mr-2" />
      Aggiungi
    </Button>
    <Button variant="destructive" onClick={() => onConfirm('replace')}>
      <RefreshCw className="h-4 w-4 mr-2" />
      Sostituisci
    </Button>
  </div>
</div>
```

Props:
- templates: GroupTemplateWithExercises[]
- hasGroupExercises: boolean
- onApply: (templateId: string, mode: 'add' | 'replace') => void
- onClose: () => void

**Update src/components/templates/index.ts:**
Add export for ApplyTemplateDialog.

**src/pages/SessionDetail.tsx:**
Add "Applica Template" button and integrate dialog.

1. Add imports:
```typescript
import { ApplyTemplateDialog } from '@/components/templates'
import { useGroupTemplates } from '@/hooks/useGroupTemplates'
import { LayoutTemplate } from 'lucide-react'
```

2. Add hook and state:
```typescript
const { templates, applyTemplateToSession } = useGroupTemplates()
const [showApplyTemplate, setShowApplyTemplate] = useState(false)
```

3. Add button next to "Aggiungi" in exercises section header:
```tsx
<Button size="sm" variant="outline" onClick={() => setShowApplyTemplate(true)}>
  <LayoutTemplate className="h-4 w-4 mr-2" />
  Template
</Button>
```

4. Add handler for apply:
```typescript
const handleApplyTemplate = async (templateId: string, mode: 'add' | 'replace') => {
  if (!id) return
  const success = await applyTemplateToSession(id, templateId, mode)
  if (success) {
    await loadSession(id)
  }
  setShowApplyTemplate(false)
}
```

5. Render dialog:
```tsx
{showApplyTemplate && (
  <ApplyTemplateDialog
    templates={templates}
    hasGroupExercises={(session.exercises?.filter(e => e.is_group).length || 0) > 0}
    onApply={handleApplyTemplate}
    onClose={() => setShowApplyTemplate(false)}
  />
)}
```
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -i "error" || echo "Build OK"
```
  </verify>
  <done>ApplyTemplateDialog created and integrated with SessionDetail</done>
</task>

<task type="auto">
  <name>Task 3: Block editing for template-linked exercises</name>
  <files>src/components/sessions/SessionExerciseCard.tsx</files>
  <action>
Modify SessionExerciseCard to disable editing when exercise has template_id.

CONTEXT.md decision: "Block editing in session: coach must edit the template itself to change exercises"

Changes:

1. Check if exercise is from template:
```typescript
const isFromTemplate = Boolean(exercise.template_id)
```

2. Disable all edit controls when isFromTemplate is true:
   - Disable +/- buttons for sets, reps, weight_kg, duration_seconds
   - Make inputs read-only
   - Disable notes textarea
   - Disable exercise change (hide RefreshCw icon, make name non-clickable)
   - Disable remove button
   - Disable move up/down buttons
   - Keep skipped toggle enabled (coach can still skip individual exercises)

3. Add visual indicator for template exercises:
```tsx
{isFromTemplate && (
  <Badge variant="outline" className="text-xs gap-1 border-dashed">
    <LayoutTemplate className="h-3 w-3" />
    Template
  </Badge>
)}
```
Show this badge next to the "Gruppo" badge.

4. Update input/button styling when disabled:
```tsx
<Button
  disabled={isFromTemplate}
  className={isFromTemplate ? 'opacity-50 cursor-not-allowed' : ''}
  // ...
>
```

5. Add import for LayoutTemplate icon from lucide-react.

6. Update the type in props to include template_id:
The SessionExerciseWithDetails type should already include template_id from Task 1 of Plan 06-01.
  </action>
  <verify>
```bash
npm run build 2>&1 | grep -i "error" || echo "Build OK"
grep "isFromTemplate" /home/toto/scm-projects/helix/src/components/sessions/SessionExerciseCard.tsx
```
  </verify>
  <done>SessionExerciseCard disables editing for template-linked exercises with visual indicator</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Apply template to session with linked behavior and edit blocking</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Create a template with 2-3 exercises (if not already done)
3. Go to a session with no group exercises
4. Click "Template" button in exercises section
5. Select a template - should apply immediately
6. Verify exercises appear with "Template" badge
7. Try to edit a template exercise:
   - Verify all controls are disabled (grayed out)
   - Verify skipped toggle still works
8. Go to another session with existing group exercises
9. Click "Template" button
10. Select a template
11. Verify Add/Replace mode dialog appears
12. Choose "Aggiungi" - verify template exercises are added
13. Choose "Sostituisci" on another session - verify existing group exercises are replaced
  </how-to-verify>
  <resume-signal>Type "approved" if apply template and edit blocking work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run build`
2. Template button visible in SessionDetail exercises section
3. ApplyTemplateDialog opens and shows templates
4. Add/Replace mode selection works when session has group exercises
5. Template exercises are linked (have template_id)
6. Template exercises show "Template" badge
7. Template exercises have disabled controls (except skipped)
</verification>

<success_criteria>
- Can apply template from SessionDetail page
- Mode selection (Add/Replace) when session has group exercises
- Template exercises are inserted with template_id set
- Template-linked exercises have "Template" visual indicator
- Template-linked exercises cannot be edited (controls disabled)
- Template-linked exercises can still be marked as skipped
- All operations save correctly to database
</success_criteria>

<output>
After completion, create `.planning/phases/06-template-management-ui/06-03-SUMMARY.md`
</output>
