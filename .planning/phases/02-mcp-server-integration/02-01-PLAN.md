---
phase: 02-mcp-server-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/functions/helix-mcp/index.ts
autonomous: true

must_haves:
  truths:
    - "Claude can read is_group from session exercises via MCP resources"
    - "Claude can create exercises with is_group=true via add_session_exercise"
    - "Claude can modify is_group on existing exercises via update_session_exercise"
    - "Claude can create training plans with group exercises via create_training_plan"
    - "Duplicated sessions preserve is_group flag on exercises"
  artifacts:
    - path: "supabase/functions/helix-mcp/index.ts"
      provides: "MCP server with is_group support in resources and tools"
      contains: "is_group"
  key_links:
    - from: "helix://clients/{id}/sessions"
      to: "session_exercises.is_group"
      via: "Supabase select query"
      pattern: "is_group"
    - from: "add_session_exercise tool"
      to: "session_exercises.is_group"
      via: "Supabase insert"
      pattern: "is_group: is_group \\|\\| false"
---

<objective>
Add is_group field support to MCP server resources and tools.

Purpose: Enable Claude to read and write the is_group flag on session exercises via MCP protocol, completing the group exercise feature's backend integration.

Output: Updated helix-mcp Edge Function with is_group exposed in all relevant resources and tools.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mcp-server-integration/02-RESEARCH.md
@supabase/functions/helix-mcp/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add is_group to resource queries</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Add `is_group` to the session_exercises field list in three resource queries:

1. **helix://clients/{id}/sessions** (around line 552-553):
   Change the exercises select from:
   ```
   id, order_index, sets, reps, weight_kg, duration_seconds, notes, completed, skipped,
   ```
   To:
   ```
   id, order_index, sets, reps, weight_kg, duration_seconds, notes, completed, skipped, is_group,
   ```

2. **helix://sessions/date/{date}** (around line 700-701):
   Same change - add `is_group` after `skipped` in the field list.

3. **helix://today** (around line 765-766):
   Same change - add `is_group` after `skipped` in the field list.

Note: `helix://sessions/{id}` already uses `*` wildcard so it automatically includes is_group.
  </action>
  <verify>
Search for "completed, skipped" in the file - should find 0 occurrences after change (all should be "completed, skipped, is_group").
  </verify>
  <done>
All three resource queries (clients/{id}/sessions, sessions/date/{date}, today) include is_group in the session_exercises field list.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add is_group to tool schemas</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Add `is_group` parameter to three tool input schemas in getToolDefinitions():

1. **add_session_exercise** (around line 361, after `notes`):
   Add property:
   ```typescript
   is_group: { type: "boolean", description: "Esercizio di gruppo" },
   ```

2. **update_session_exercise** (around line 379, after `skipped`):
   Add property:
   ```typescript
   is_group: { type: "boolean", description: "Esercizio di gruppo" },
   ```

3. **create_training_plan** nested exercises schema (around line 426, after `notes`):
   Add property inside the exercises array item object:
   ```typescript
   is_group: { type: "boolean" },
   ```
  </action>
  <verify>
Count occurrences of "is_group" in getToolDefinitions function - should be 3 (one in each tool schema).
  </verify>
  <done>
Tool schemas for add_session_exercise, update_session_exercise, and create_training_plan include is_group as optional boolean parameter.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add is_group to tool handlers</name>
  <files>supabase/functions/helix-mcp/index.ts</files>
  <action>
Update four tool handlers in executeTool() to handle is_group:

1. **add_session_exercise handler** (around line 1140-1178):
   - Add `is_group` to the destructured args type (around line 1141):
     ```typescript
     const { session_id, exercise_id, order_index, sets, reps, weight_kg, duration_seconds, notes, is_group } = args as {
       // ... existing types ...
       is_group?: boolean
     }
     ```
   - Add `is_group: is_group || false,` to the insert object (around line 1177, after `skipped: false,`)

2. **update_session_exercise handler** (around line 1189-1208):
   - Add `is_group` to the destructured args type (around line 1190):
     ```typescript
     const { session_exercise_id, sets, reps, weight_kg, duration_seconds, notes, completed, skipped, is_group } = args as {
       // ... existing types ...
       is_group?: boolean
     }
     ```
   - Add check for is_group in updates object (around line 1208, after skipped check):
     ```typescript
     if (is_group !== undefined) updates.is_group = is_group
     ```

3. **duplicate_session handler** (around line 1079-1132):
   - Add `is_group` to the select query (around line 1083):
     ```typescript
     exercises:session_exercises(exercise_id, order_index, sets, reps, weight_kg, duration_seconds, notes, is_group)
     ```
   - Add `is_group` to the type definition (around line 1117):
     ```typescript
     is_group: boolean
     ```
   - Add `is_group: ex.is_group,` to the newExercises mapping (around line 1131, after `notes: ex.notes,`)

4. **create_training_plan handler** (around line 1254-1332):
   - Add `is_group` to the exercises array type (around line 1266):
     ```typescript
     is_group?: boolean
     ```
   - Add `is_group: ex.is_group || false,` to the insert object (around line 1326, after `notes: ex.notes || null,`)
  </action>
  <verify>
Test with curl commands against local Supabase:
```bash
# Start Supabase functions if not running
# Then test tools/list to see updated schemas
curl -s -X POST http://127.0.0.1:54321/functions/v1/helix-mcp \
  -H "Content-Type: application/json" \
  -H "X-Helix-API-Key: $TEST_API_KEY" \
  -d '{"jsonrpc": "2.0", "method": "tools/list", "id": 1, "params": {}}' | grep -o "is_group" | wc -l
# Should output 3 (one per tool schema)
```
  </verify>
  <done>
All four tool handlers (add_session_exercise, update_session_exercise, duplicate_session, create_training_plan) properly read and write is_group field.
  </done>
</task>

</tasks>

<verification>
## Overall Verification

After all tasks complete:

1. **Static check - grep for is_group occurrences:**
   ```bash
   grep -c "is_group" supabase/functions/helix-mcp/index.ts
   # Should be >= 15 occurrences
   ```

2. **No "completed, skipped," without is_group:**
   ```bash
   grep "completed, skipped," supabase/functions/helix-mcp/index.ts | grep -v "is_group"
   # Should return no lines (all should have is_group after skipped)
   ```

3. **Tool schemas have is_group:**
   ```bash
   grep -A2 '"is_group"' supabase/functions/helix-mcp/index.ts | head -20
   # Should show is_group definitions in tool schemas
   ```

4. **Local functional test (if Supabase is running):**
   - resources/list should work
   - tools/list should show is_group in relevant tool schemas
   - Creating a session exercise with is_group=true should persist

</verification>

<success_criteria>
- [ ] is_group field appears in helix://clients/{id}/sessions resource response
- [ ] is_group field appears in helix://sessions/date/{date} resource response
- [ ] is_group field appears in helix://today resource response
- [ ] add_session_exercise tool schema includes is_group parameter
- [ ] update_session_exercise tool schema includes is_group parameter
- [ ] create_training_plan tool schema includes is_group in exercises
- [ ] add_session_exercise handler inserts is_group with default false
- [ ] update_session_exercise handler can update is_group
- [ ] duplicate_session preserves is_group when copying exercises
- [ ] create_training_plan inserts is_group from exercise list
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-server-integration/02-01-SUMMARY.md`
</output>
