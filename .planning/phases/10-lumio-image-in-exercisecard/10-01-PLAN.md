---
phase: 10-lumio-image-in-exercisecard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/shared/hooks/useLiveCoaching.ts
  - src/shared/types/index.ts
  - src/live/components/ImageGallery.tsx
autonomous: true

must_haves:
  truths:
    - "Lumio card images data is available on SessionExerciseWithDetails when the exercise has a Lumio card with images"
    - "Image gallery component renders images with swipe navigation isolated from parent touch events"
    - "Gallery shows dot indicators for multi-image cards"
  artifacts:
    - path: "src/shared/hooks/useLiveCoaching.ts"
      provides: "Lumio card images included in session exercise query"
      contains: "lumio_card_images"
    - path: "src/shared/types/index.ts"
      provides: "LumioLocalCardWithImages type extending LumioLocalCardWithRepository"
      contains: "LumioLocalCardWithImages"
    - path: "src/live/components/ImageGallery.tsx"
      provides: "Swipeable image gallery component for inline exercise card use"
      contains: "ImageGallery"
  key_links:
    - from: "src/shared/hooks/useLiveCoaching.ts"
      to: "lumio_card_images table"
      via: "Supabase nested select join"
      pattern: "images:lumio_card_images"
    - from: "src/live/components/ImageGallery.tsx"
      to: "supabase storage"
      via: "getPublicUrl for storage_path"
      pattern: "getPublicUrl"
---

<objective>
Add Lumio card images to the live coaching data layer and create a standalone swipeable image gallery component.

Purpose: Provide the data foundation and UI building block needed to display exercise images in the ExerciseCard carousel. The gallery component handles its own touch gestures independently so it can be embedded inside the carousel without swipe conflicts.

Output: Updated data query with images, extended types, and a reusable ImageGallery component.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/shared/hooks/useLiveCoaching.ts
@src/shared/types/index.ts
@src/hooks/useLumioCards.ts
@src/lib/lumio-images.ts
@src/live/components/ExerciseCard.tsx
@src/live/components/ExerciseCarousel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Lumio card images to data layer and types</name>
  <files>src/shared/hooks/useLiveCoaching.ts, src/shared/types/index.ts</files>
  <action>
  **Types (src/shared/types/index.ts):**
  - Add a new interface `LumioLocalCardWithImages` that extends `LumioLocalCardWithRepository` and adds an optional `images?: LumioCardImage[]` field
  - Update `ExerciseWithDetails` to change `lumio_card` type from `LumioLocalCardWithRepository | null` to `LumioLocalCardWithImages | null`

  **Data query (src/shared/hooks/useLiveCoaching.ts):**
  - In `fetchSessionsForDate`, update the Supabase select query to include `lumio_card_images` as a nested join inside the lumio_cards relation:
    ```
    exercise:exercises(
      *,
      lumio_card:lumio_cards(
        *,
        repository:lumio_repositories(*),
        images:lumio_card_images(*)
      )
    )
    ```
  - The `images` field will automatically be included in the response because Supabase returns all fields from joined tables
  - No other changes needed — the query already flows through to `SessionExerciseWithDetails.exercise.lumio_card`

  **Important:** The `lumio_card_images` table has RLS policies that check `auth.uid()` via join with `lumio_cards`. The authenticated user's session is already established by the live tablet login, so this join will work correctly.
  </action>
  <verify>
  - `npm run build` succeeds with no TypeScript errors
  - The `LumioLocalCardWithImages` type exists and extends `LumioLocalCardWithRepository`
  - The `fetchSessionsForDate` query string contains `images:lumio_card_images`
  </verify>
  <done>
  - Session exercises with Lumio cards that have images include the `images` array in the data
  - Exercises without Lumio cards or without images are unaffected (images will be an empty array or lumio_card will be null)
  - TypeScript types correctly reflect the new data shape
  </done>
</task>

<task type="auto">
  <name>Task 2: Create standalone swipeable ImageGallery component</name>
  <files>src/live/components/ImageGallery.tsx</files>
  <action>
  Create `src/live/components/ImageGallery.tsx` — a touch-friendly inline image gallery for the live tablet ExerciseCard.

  **Props:**
  ```typescript
  interface ImageGalleryProps {
    images: LumioCardImage[]
    userId: string
    repositoryId: string
    maxHeight: string  // CSS max-height value (e.g., "40%", "120px")
    className?: string
  }
  ```

  **Image URL resolution:**
  - For each image, build the public URL using Supabase Storage:
    ```typescript
    import { supabase } from '@/shared/lib/supabase'
    const { data } = supabase.storage.from('lumio-images').getPublicUrl(image.storage_path)
    ```
  - This matches the existing pattern in `useLumioCards.ts` `getImageUrl` function

  **Gallery behavior:**
  - Show one image at a time with CSS `overflow: hidden` and `transform: translateX()` for slide positioning
  - Track `currentImageIndex` in local state (useState)
  - Single-image cards: no indicators, no swipe handlers
  - Multi-image cards: show dot indicators below the image, enable swipe navigation

  **Touch gesture isolation (CRITICAL per user decision):**
  - Gallery swipe must NOT propagate to the parent ExerciseCarousel
  - On `onTouchStart`: call `e.stopPropagation()` immediately, record start X position
  - On `onTouchMove`: call `e.stopPropagation()`, track current X position
  - On `onTouchEnd`: call `e.stopPropagation()`, calculate distance. If > 30px threshold, navigate images. Otherwise, no action.
  - This ensures the main carousel's swipe (which uses its own touch handlers on the grid container) never receives touch events that start inside the gallery

  **Slide animation:**
  - Use CSS `transition: transform 300ms ease-out` for smooth sliding
  - Position all images side-by-side using `transform: translateX(-${currentIndex * 100}%)`

  **Dot indicators:**
  - Small dots below the image (only when images.length > 1)
  - Current dot: `bg-amber-400` (matches carousel progress dots)
  - Other dots: `bg-white/40`
  - Dots are 6px circles, gap-1

  **Loading state:**
  - Use a subtle gray skeleton placeholder (`bg-gray-700 animate-pulse`) matching the maxHeight while image loads
  - Track loaded state per image with `onLoad` callback
  - Collapse (display nothing) on error — don't show broken image icons

  **Image styling:**
  - `object-contain` to preserve aspect ratio (per user decision: no cropping)
  - Rounded corners: `rounded-lg` (8px)
  - Images fill the gallery width, constrained by maxHeight
  - `select-none` and `pointer-events-none` on the img element to prevent drag behavior
  </action>
  <verify>
  - `npm run build` succeeds with no TypeScript errors
  - The component file exists at `src/live/components/ImageGallery.tsx`
  - The component exports `ImageGallery` as a named export
  - Touch handlers call `e.stopPropagation()` to isolate gestures
  </verify>
  <done>
  - ImageGallery renders images from Lumio card image data using Supabase Storage public URLs
  - Single-image: shows image without indicators or swipe
  - Multi-image: shows image with dot indicators, swipe navigates between images with smooth slide animation
  - Touch events are isolated — gallery swipe does not trigger parent carousel swipe
  - Loading shows skeleton, error collapses gracefully
  </done>
</task>

</tasks>

<verification>
- `npm run build` passes cleanly
- Types compile without errors
- ImageGallery component exists and handles single/multi image cases
- Touch event isolation is implemented via stopPropagation
</verification>

<success_criteria>
- LumioLocalCardWithImages type defined with images field
- useLiveCoaching query includes lumio_card_images join
- ImageGallery component renders, handles swipe, shows indicators
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-lumio-image-in-exercisecard/10-01-SUMMARY.md`
</output>
