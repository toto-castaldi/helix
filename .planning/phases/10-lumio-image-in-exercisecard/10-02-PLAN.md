---
phase: 10-lumio-image-in-exercisecard
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/live/components/ExerciseCard.tsx
  - src/live/components/ExerciseCarousel.tsx
autonomous: false

must_haves:
  truths:
    - "Exercise card on live tablet shows the first Lumio image (or gallery) between the title and notes section"
    - "Parameters (Serie, Reps, Peso, Durata) are always visible without scrolling"
    - "Exercise cards without Lumio images display exactly as before (no empty space, no placeholder)"
    - "Gallery swipe inside the image area does not trigger carousel navigation"
    - "Images for current +/- 1 cards are preloaded for smooth carousel transitions"
  artifacts:
    - path: "src/live/components/ExerciseCard.tsx"
      provides: "Redesigned card layout with conditional image gallery"
      contains: "ImageGallery"
    - path: "src/live/components/ExerciseCarousel.tsx"
      provides: "Image preloading for adjacent cards"
      contains: "preload"
  key_links:
    - from: "src/live/components/ExerciseCard.tsx"
      to: "src/live/components/ImageGallery.tsx"
      via: "conditional render when lumio_card has images"
      pattern: "lumio_card.*images.*length"
    - from: "src/live/components/ExerciseCarousel.tsx"
      to: "supabase storage"
      via: "hidden Image preload elements for adjacent cards"
      pattern: "preload|link.*rel"
---

<objective>
Redesign the ExerciseCard layout to display Lumio images inline and add image preloading for smooth carousel transitions.

Purpose: Give coaches a visual reference for each exercise during live sessions, improving coaching efficiency. The card layout adapts: exercises with images show them prominently, exercises without images use the original layout unchanged.

Output: Updated ExerciseCard with conditional image gallery, preloading in ExerciseCarousel, verified on tablet.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-lumio-image-in-exercisecard/10-01-SUMMARY.md

@src/live/components/ExerciseCard.tsx
@src/live/components/ExerciseCarousel.tsx
@src/live/components/ImageGallery.tsx
@src/shared/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Redesign ExerciseCard layout with conditional image gallery</name>
  <files>src/live/components/ExerciseCard.tsx</files>
  <action>
  Redesign the ExerciseCard to conditionally show images when the exercise has a Lumio card with images. The card must NOT grow taller — space is redistributed.

  **Determine if images exist:**
  ```typescript
  import type { LumioLocalCardWithImages } from '@/shared/types'
  const lumioCard = exercise.exercise?.lumio_card as LumioLocalCardWithImages | null | undefined
  const lumioImages = lumioCard?.images || []
  const hasImages = lumioImages.length > 0
  ```

  **Layout when `hasImages === true` (new layout per user decision):**
  The card sections change order and proportions. Total card height remains the same (h-full).
  Use a flex column layout with these sections:

  1. **Title** — fixed size, ~15% of card height
     - Exercise name (text-xl font-bold, line-clamp-2 instead of 3)
     - Badges (group, completed, skipped) — same as current
  2. **Image gallery** — max ~40% of card height
     - Render `<ImageGallery images={lumioImages} userId={lumioCard.repository?.user_id || ''} repositoryId={lumioCard.repository?.id || ''} maxHeight="40%" />`
     - The gallery handles its own touch events (stopPropagation)
  3. **Notes** — flexible, takes remaining space between image and parameters
     - For non-current exercises: `text-xs text-gray-500 italic line-clamp-2` with overflow hidden
     - For current exercise: Textarea (but shorter, constrained by available space)
     - Tap to expand: When notes are truncated on non-current cards, tapping would normally navigate carousel. Since this is view-only on non-current cards, truncation with "..." via line-clamp is sufficient.
  4. **Parameters** — fixed size, ~35% of card height, ALWAYS visible (hard constraint)
     - Same 2x2 grid: Serie, Reps, Peso, Durata
     - `mt-auto` to push to bottom of card — ensures parameters are always at the bottom regardless of image/notes size

  **Layout when `hasImages === false` (original layout, unchanged):**
  Keep the existing layout exactly:
  1. Title (30%) — `h-[30%]`
  2. Description (20%) — `h-[20%]`
  3. Controls/Parameters (30%) — `h-[30%]`
  4. Notes (20%) — `h-[20%]`

  This means the component renders two different layouts based on `hasImages`. Use a simple conditional:
  ```tsx
  {hasImages ? (
    // New layout with image
  ) : (
    // Original layout (existing code, unchanged)
  )}
  ```

  **Important implementation notes:**
  - The card dimensions are fixed: `w-[320px] h-full` — do NOT change these
  - Use `flex flex-col` for the image layout variant, with `flex-shrink-0` on title and parameters
  - The notes section gets `flex-1 min-h-0 overflow-hidden` to take whatever space remains
  - For current exercise notes with image: use a smaller Textarea with `h-full` constrained by flex
  - Description section is REMOVED in the image layout (replaced by the image — the Lumio card content IS the description)
  </action>
  <verify>
  - `npm run build` succeeds
  - ExerciseCard imports and uses ImageGallery component
  - Cards without images render the original 4-section layout (no changes)
  - Cards with images render the new Title → Image → Notes → Parameters layout
  </verify>
  <done>
  - ExerciseCard shows Lumio images between title and notes when present
  - Parameters are always at the bottom of the card, visible without scrolling
  - Cards without images are visually identical to the current production layout
  - Image gallery is properly integrated with touch isolation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add image preloading for adjacent carousel cards</name>
  <files>src/live/components/ExerciseCarousel.tsx</files>
  <action>
  Add image preloading so that when the coach swipes to the next/previous exercise, images are already cached by the browser.

  **Strategy:**
  - After rendering the 3 visible cards (prev, current, next), add a hidden preload section
  - Preload the FIRST image of exercises at `currentIndex - 1` and `currentIndex + 1` (if they have Lumio images)
  - Use hidden `<img>` elements with `display: none` — these trigger browser image caching without visual impact
  - Also preload images for `currentIndex - 2` and `currentIndex + 2` if they exist (one step ahead of visible range)

  **Implementation:**
  ```typescript
  import type { LumioLocalCardWithImages } from '@/shared/types'
  import { supabase } from '@/shared/lib/supabase'

  // Helper to get first image URL for an exercise
  function getFirstImageUrl(exercise: SessionExerciseWithDetails): string | null {
    const lumioCard = exercise.exercise?.lumio_card as LumioLocalCardWithImages | null | undefined
    const images = lumioCard?.images
    if (!images || images.length === 0) return null
    const { data } = supabase.storage.from('lumio-images').getPublicUrl(images[0].storage_path)
    return data.publicUrl
  }
  ```

  Add after the cards grid container (but still inside the main div), render hidden preload images:
  ```tsx
  {/* Preload images for adjacent exercises */}
  <div className="hidden" aria-hidden="true">
    {[-2, -1, 1, 2].map(offset => {
      const idx = currentIndex + offset
      if (idx < 0 || idx >= exercises.length) return null
      const url = getFirstImageUrl(exercises[idx])
      if (!url) return null
      return <img key={`preload-${idx}`} src={url} alt="" />
    })}
  </div>
  ```

  This is lightweight — at most 4 hidden images, and only for exercises that have Lumio images. The browser will cache these, making carousel transitions instant when the user swipes to an adjacent card.

  **Note on gallery preloading:** For multi-image galleries, only the FIRST image of each adjacent card is preloaded. Remaining gallery images load on demand when the user swipes within the gallery. This is a reasonable tradeoff — the first image is what the coach sees immediately, and subsequent gallery images can load while viewing.
  </action>
  <verify>
  - `npm run build` succeeds
  - Hidden preload images are rendered for adjacent exercises with Lumio images
  - Exercises without images produce no preload elements
  </verify>
  <done>
  - First images of exercises at currentIndex +/- 1 and +/- 2 are preloaded via hidden img elements
  - Preloading is lightweight (max 4 images) and only targets exercises with Lumio images
  - Carousel transitions feel smooth because images are browser-cached before becoming visible
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual verification on live tablet</name>
  <files>src/live/components/ExerciseCard.tsx, src/live/components/ExerciseCarousel.tsx, src/live/components/ImageGallery.tsx</files>
  <action>
  Human verifies that ExerciseCard on the live tablet shows Lumio card images inline. The card layout adapts:
  - With images: Title, Image Gallery, Notes, Parameters
  - Without images: Original layout (Title, Description, Controls, Notes)

  Image gallery supports swipe between multiple images with dot indicators. Gallery swipe is isolated from carousel swipe.

  Verification steps:
  1. Start dev servers: `npm run dev` and `npm run dev:live`
  2. Open `http://localhost:5174` in the browser (or tablet)
  3. Select a date that has sessions with exercises

  Test 1 — Exercise WITH Lumio images:
  - Find an exercise that has a Lumio card with images
  - Verify image appears between the title and notes
  - Verify parameters (Serie, Reps, Peso, Durata) are visible at the bottom
  - Verify image maintains aspect ratio (not stretched or cropped)
  - If multiple images: swipe horizontally inside the image area — dots should update, images should slide
  - Verify swiping on the image does NOT navigate to the next exercise card

  Test 2 — Exercise WITHOUT Lumio images:
  - Find an exercise without a Lumio card
  - Verify card looks exactly the same as before (Title, Description, Controls, Notes)
  - No empty space or placeholder where image would be

  Test 3 — Carousel swipe:
  - Swipe left/right outside the image area on a card with images
  - Verify carousel navigates to next/previous exercise normally
  - Verify transition is smooth (images preloaded)

  Test 4 — Mixed exercises:
  - Navigate between cards with and without images
  - Verify each card displays correctly based on its image availability
  - No layout glitches or jumps when transitioning between card types
  </action>
  <verify>Human confirms all 4 test scenarios pass on the live tablet</verify>
  <done>All visual and interaction tests pass — images display correctly, layout is stable, gestures are isolated</done>
</task>

</tasks>

<verification>
- `npm run build` passes cleanly
- Exercise cards with Lumio images show inline gallery between title and notes
- Exercise cards without images are unchanged
- Parameters are always visible at card bottom
- Gallery swipe is isolated from carousel swipe
- Images preloaded for adjacent cards
</verification>

<success_criteria>
- IMG-01: Live tablet exercise card shows first Lumio image in carousel card
- IMG-02: Image fits within card without breaking layout (name, parameters, notes visible)
- IMG-03: Cards without Lumio images display exactly as before
- Gallery swipe and carousel swipe work independently
- Human verification confirms visual correctness on tablet
</success_criteria>

<output>
After completion, create `.planning/phases/10-lumio-image-in-exercisecard/10-02-SUMMARY.md`
</output>
