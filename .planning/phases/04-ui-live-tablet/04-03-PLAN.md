---
phase: 04-ui-live-tablet
plan: 03
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - src/live/components/GroupExerciseView.tsx
  - src/live/components/GroupExerciseCard.tsx
  - src/live/components/ExerciseCard.tsx
  - src/live/pages/TabletLive.tsx
autonomous: true

must_haves:
  truths:
    - "Group view shows all group exercises from all sessions of the day"
    - "Each group exercise card shows participant avatars"
    - "Complete-for-all marks exercise as completed for all participants"
    - "Skip individual marks only that participant's exercise as skipped"
    - "Toast with undo appears after complete-for-all action"
    - "ExerciseCard shows group badge when is_group=true"
  artifacts:
    - path: "src/live/components/GroupExerciseView.tsx"
      provides: "Group exercise aggregation and list view"
      min_lines: 80
    - path: "src/live/components/GroupExerciseCard.tsx"
      provides: "Card with participants and complete/skip actions"
      min_lines: 100
    - path: "src/live/components/ExerciseCard.tsx"
      provides: "Group badge indicator"
      contains: "is_group"
    - path: "src/live/pages/TabletLive.tsx"
      provides: "GroupExerciseView integration"
      contains: "GroupExerciseView"
  key_links:
    - from: "GroupExerciseView.tsx"
      to: "sessions data"
      via: "props from TabletLive"
      pattern: "sessions.*map"
    - from: "GroupExerciseCard.tsx"
      to: "completeGroupExercise"
      via: "onClick handler"
      pattern: "onComplete.*completeGroupExercise"
    - from: "GroupExerciseCard.tsx"
      to: "skipGroupExerciseForClient"
      via: "onClick handler"
      pattern: "onSkip.*skipGroupExerciseForClient"
---

<objective>
Create GroupExerciseView and GroupExerciseCard components, add group badge to ExerciseCard, integrate into TabletLive.

Purpose: The group view aggregates exercises by exercise_id, shows participants with ClientAvatar, enables complete-for-all with toast undo, and skip-per-individual.

Output: Complete group view UI with all interactions working.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ui-live-tablet/04-CONTEXT.md
@.planning/phases/04-ui-live-tablet/04-RESEARCH.md
@.planning/phases/04-ui-live-tablet/04-02-PLAN.md

# Components to reference/modify
@src/live/components/ExerciseCard.tsx
@src/live/components/ClientAvatar.tsx
@src/live/pages/TabletLive.tsx
@src/shared/hooks/useLiveCoaching.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add group badge to ExerciseCard</name>
  <files>src/live/components/ExerciseCard.tsx</files>
  <action>
Modify ExerciseCard.tsx to show a group badge when is_group=true:

1. **Import Users icon from lucide-react**

2. **Add badge next to completed/skipped badges** in the title section:
   ```typescript
   {exercise.is_group && (
     <Badge className="bg-violet-600 ml-2 flex-shrink-0 p-1">
       <Users className="w-4 h-4" />
     </Badge>
   )}
   ```

Place after the isCompleted and isSkipped badges but before them visually (group is a property, not a state).

Alternatively, place it first so order is: Group badge (if applicable) | Completed OR Skipped badge
  </action>
  <verify>
`npm run build` succeeds.
ExerciseCard shows violet Users badge when exercise.is_group is true.
  </verify>
  <done>ExerciseCard displays group badge for group exercises.</done>
</task>

<task type="auto">
  <name>Task 2: Create GroupExerciseCard component</name>
  <files>src/live/components/GroupExerciseCard.tsx</files>
  <action>
Create new component GroupExerciseCard.tsx:

```typescript
import { Card, CardContent } from '@/shared/components/ui/card'
import { Badge } from '@/shared/components/ui/badge'
import { Button } from '@/shared/components/ui/button'
import { ClientAvatar } from './ClientAvatar'
import { cn } from '@/shared/lib/utils'
import { Check, SkipForward, Users, X } from 'lucide-react'
import type { Client, ExerciseWithDetails } from '@/shared/types'

interface Participant {
  sessionExerciseId: string
  client: Client
  completed: boolean
  skipped: boolean
}

interface GroupExerciseCardProps {
  exerciseId: string
  exerciseName: string
  exercise: ExerciseWithDetails
  participants: Participant[]
  allCompleted: boolean
  someCompleted: boolean
  onCompleteAll: () => void
  onSkipParticipant: (sessionExerciseId: string, clientName: string) => void
}

export function GroupExerciseCard({
  exerciseName,
  exercise,
  participants,
  allCompleted,
  someCompleted,
  onCompleteAll,
  onSkipParticipant,
}: GroupExerciseCardProps) {
  // Sort participants: pending first, then completed, then skipped
  const sortedParticipants = [...participants].sort((a, b) => {
    if (a.completed === b.completed && a.skipped === b.skipped) return 0
    if (!a.completed && !a.skipped) return -1
    if (!b.completed && !b.skipped) return 1
    if (a.completed && !b.completed) return -1
    return 1
  })

  const pendingCount = participants.filter(p => !p.completed && !p.skipped).length
  const completedCount = participants.filter(p => p.completed).length
  const skippedCount = participants.filter(p => p.skipped).length

  return (
    <Card className={cn(
      'transition-all w-full',
      allCompleted ? 'bg-emerald-900/30 border-emerald-600 border-2' : 'bg-gray-800 border-gray-700'
    )}>
      <CardContent className="p-4">
        {/* Header */}
        <div className="flex items-start justify-between mb-3">
          <div className="flex-1">
            <div className="flex items-center gap-2">
              <h3 className="text-xl font-bold text-white">{exerciseName}</h3>
              <Badge className="bg-violet-600">
                <Users className="w-3 h-3 mr-1" />
                {participants.length}
              </Badge>
            </div>
            {exercise.description && (
              <p className="text-sm text-gray-400 mt-1 line-clamp-2">{exercise.description}</p>
            )}
          </div>

          {/* Complete All Button */}
          {!allCompleted && (
            <Button
              onClick={onCompleteAll}
              size="lg"
              className="bg-emerald-600 hover:bg-emerald-700 text-white ml-4"
            >
              <Check className="w-5 h-5 mr-2" />
              Completa tutti
            </Button>
          )}
          {allCompleted && (
            <Badge className="bg-emerald-600 p-2">
              <Check className="w-5 h-5" />
            </Badge>
          )}
        </div>

        {/* Status summary */}
        <div className="flex gap-4 text-sm mb-3">
          {pendingCount > 0 && (
            <span className="text-gray-400">{pendingCount} in attesa</span>
          )}
          {completedCount > 0 && (
            <span className="text-emerald-400">{completedCount} completati</span>
          )}
          {skippedCount > 0 && (
            <span className="text-amber-400">{skippedCount} saltati</span>
          )}
        </div>

        {/* Participants */}
        <div className="flex flex-wrap gap-3">
          {sortedParticipants.map((participant) => (
            <div
              key={participant.sessionExerciseId}
              className={cn(
                'flex items-center gap-2 p-2 rounded-lg',
                participant.completed && 'bg-emerald-900/30',
                participant.skipped && 'bg-amber-900/30',
                !participant.completed && !participant.skipped && 'bg-gray-700'
              )}
            >
              <ClientAvatar
                client={participant.client}
                size="sm"
                selected={true}
              />
              <span className="text-sm text-white">
                {participant.client.first_name}
              </span>

              {participant.completed && (
                <Badge className="bg-emerald-600 p-1">
                  <Check className="w-3 h-3" />
                </Badge>
              )}

              {participant.skipped && (
                <Badge className="bg-amber-600 p-1">
                  <SkipForward className="w-3 h-3" />
                </Badge>
              )}

              {/* Skip button for pending participants */}
              {!participant.completed && !participant.skipped && (
                <Button
                  onClick={() => onSkipParticipant(
                    participant.sessionExerciseId,
                    participant.client.first_name
                  )}
                  size="sm"
                  variant="ghost"
                  className="p-1 h-auto text-amber-400 hover:text-amber-300 hover:bg-amber-900/30"
                >
                  <X className="w-4 h-4" />
                </Button>
              )}
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  )
}
```

Key features:
- Shows exercise name with participant count badge
- "Completa tutti" button when not all completed
- Participant list with ClientAvatar
- Each pending participant has skip (X) button
- Visual states for completed/skipped participants
  </action>
  <verify>
`npm run build` succeeds.
Component exports GroupExerciseCard.
**Prop signature check:** Ensure `onSkipParticipant` accepts `(sessionExerciseId: string, clientName: string)` - this matches what GroupExerciseView will pass.
  </verify>
  <done>GroupExerciseCard component created with all required functionality and correct prop signature for wiring.</done>
</task>

<task type="auto">
  <name>Task 3a: Create GroupExerciseView component with handlers</name>
  <files>src/live/components/GroupExerciseView.tsx</files>
  <action>
Create GroupExerciseView.tsx:

```typescript
import { useMemo } from 'react'
import { toast } from 'sonner'
import { GroupExerciseCard } from './GroupExerciseCard'
import type { SessionWithDetails, Client, ExerciseWithDetails } from '@/shared/types'

interface Participant {
  sessionExerciseId: string
  client: Client
  completed: boolean
  skipped: boolean
}

interface GroupedExercise {
  exerciseId: string
  exerciseName: string
  exercise: ExerciseWithDetails
  participants: Participant[]
  allCompleted: boolean
  someCompleted: boolean
}

interface GroupExerciseViewProps {
  sessions: SessionWithDetails[]
  currentDate: string
  onCompleteGroup: (exerciseId: string, exerciseName: string) => Promise<string[]>
  onSkipParticipant: (sessionExerciseId: string) => Promise<boolean>
  onUndoComplete: (exerciseIds: string[]) => Promise<void>
}

export function GroupExerciseView({
  sessions,
  currentDate,
  onCompleteGroup,
  onSkipParticipant,
  onUndoComplete,
}: GroupExerciseViewProps) {
  // Aggregate group exercises by exercise_id
  const groupedExercises = useMemo((): GroupedExercise[] => {
    const grouped = new Map<string, GroupedExercise>()

    for (const session of sessions) {
      if (!session.client) continue

      for (const ex of session.exercises || []) {
        if (!ex.is_group || !ex.exercise) continue

        const exerciseId = ex.exercise_id
        if (!grouped.has(exerciseId)) {
          grouped.set(exerciseId, {
            exerciseId,
            exerciseName: ex.exercise.name || 'Esercizio',
            exercise: ex.exercise,
            participants: [],
            allCompleted: true,
            someCompleted: false,
          })
        }

        const group = grouped.get(exerciseId)!
        group.participants.push({
          sessionExerciseId: ex.id,
          client: session.client,
          completed: ex.completed,
          skipped: ex.skipped,
        })

        if (!ex.completed && !ex.skipped) group.allCompleted = false
        if (ex.completed) group.someCompleted = true
      }
    }

    // Sort: incomplete first, then by exercise name
    return Array.from(grouped.values()).sort((a, b) => {
      if (a.allCompleted !== b.allCompleted) return a.allCompleted ? 1 : -1
      return a.exerciseName.localeCompare(b.exerciseName)
    })
  }, [sessions])

  const handleCompleteAll = async (exerciseId: string, exerciseName: string) => {
    const updatedIds = await onCompleteGroup(exerciseId, exerciseName)

    if (updatedIds.length > 0) {
      toast.success(`${exerciseName} completato per tutti`, {
        duration: 4000,
        action: {
          label: 'Annulla',
          onClick: async () => {
            await onUndoComplete(updatedIds)
            toast.info('Completamento annullato')
          }
        }
      })
    }
  }

  const handleSkipParticipant = async (sessionExerciseId: string, clientName: string) => {
    const success = await onSkipParticipant(sessionExerciseId)
    if (success) {
      toast.success(`${clientName} salta questo esercizio`)
    }
  }

  if (groupedExercises.length === 0) {
    return (
      <div className="flex-1 flex items-center justify-center text-gray-400">
        <div className="text-center">
          <p className="text-lg">Nessun esercizio di gruppo</p>
          <p className="text-sm mt-2">Gli esercizi di gruppo appariranno qui</p>
        </div>
      </div>
    )
  }

  return (
    <div className="flex-1 overflow-y-auto p-4 space-y-4">
      {groupedExercises.map((group) => (
        <GroupExerciseCard
          key={group.exerciseId}
          exerciseId={group.exerciseId}
          exerciseName={group.exerciseName}
          exercise={group.exercise}
          participants={group.participants}
          allCompleted={group.allCompleted}
          someCompleted={group.someCompleted}
          onCompleteAll={() => handleCompleteAll(group.exerciseId, group.exerciseName)}
          onSkipParticipant={handleSkipParticipant}
        />
      ))}
    </div>
  )
}
```

Key features:
- Aggregates all group exercises from all sessions by exercise_id
- Sorts incomplete exercises first
- handleCompleteAll shows toast with undo action
- handleSkipParticipant passes through to RPC
  </action>
  <verify>
`npm run build` succeeds.
Component exports GroupExerciseView.
Check that handleSkipParticipant wiring matches GroupExerciseCard's expected signature.
  </verify>
  <done>GroupExerciseView component created with exercise aggregation and handlers.</done>
</task>

<task type="auto">
  <name>Task 3b: Integrate GroupExerciseView into TabletLive with undo handler</name>
  <files>src/live/pages/TabletLive.tsx</files>
  <action>
Update TabletLive.tsx to integrate GroupExerciseView:

1. Import GroupExerciseView:
   ```typescript
   import { GroupExerciseView } from '@/live/components/GroupExerciseView'
   ```

2. Import supabase at top:
   ```typescript
   import { supabase } from '@/shared/lib/supabase'
   ```

3. Add undo function inside component body:
   ```typescript
   // Undo handler for group complete-all action
   // Note: Uses individual updates (not atomic RPC) - acceptable tradeoff for undo path
   // which is rare and doesn't require strict atomicity
   const handleUndoGroupComplete = async (exerciseIds: string[]) => {
     for (const id of exerciseIds) {
       await supabase
         .from('session_exercises')
         .update({ completed: false, completed_at: null })
         .eq('id', id)
     }
     if (date) {
       await fetchSessionsForDate(date)
     }
   }
   ```

4. Replace the placeholder in the main content conditional:
   ```typescript
   {viewMode === 'individual' ? (
     <>
       <ActionPanel ... />
       <div className="flex-1">
         {selectedSession && <ExerciseCarousel ... />}
       </div>
     </>
   ) : (
     <GroupExerciseView
       sessions={sessions}
       currentDate={date || ''}
       onCompleteGroup={async (exerciseId, exerciseName) => {
         return await completeGroupExercise(date || '', exerciseId)
       }}
       onSkipParticipant={skipGroupExerciseForClient}
       onUndoComplete={handleUndoGroupComplete}
     />
   )}
   ```

5. Ensure the main content area has proper flex layout for both views.
  </action>
  <verify>
`npm run build` succeeds.
Dev server:
- Toggle to group view shows GroupExerciseView
- "Completa tutti" button works, shows toast with "Annulla"
- Undo toast action reverts completion (verify by checking UI state)
- **REQ-LIVE-007 verification:** Click skip button on ONE participant, verify other participants in the same exercise remain in their pending/completed state (not affected by skip)
  </verify>
  <done>
GroupExerciseView integrated in TabletLive.
Complete-for-all with toast undo works.
Skip individual only affects the targeted participant (REQ-LIVE-007).
  </done>
</task>

</tasks>

<verification>
- [ ] `npm run build` succeeds
- [ ] ExerciseCard shows violet group badge when is_group=true
- [ ] Group view aggregates exercises by exercise_id
- [ ] GroupExerciseCard shows participant avatars
- [ ] "Completa tutti" marks all pending participants as completed
- [ ] Toast with "Annulla" appears for 4 seconds after complete-all
- [ ] Undo reverts the completion
- [ ] Skip button marks individual participant as skipped
- [ ] **REQ-LIVE-007:** Skip on one participant does NOT affect other participants' status
</verification>

<success_criteria>
- Group view fully functional with all REQ-LIVE requirements met
- Complete-for-all with toast undo pattern per CONTEXT.md
- Skip individual per client works (only affects targeted participant)
- Visual consistency with existing tablet UI
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-live-tablet/04-03-SUMMARY.md`
</output>
