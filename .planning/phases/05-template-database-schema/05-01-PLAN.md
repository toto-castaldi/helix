---
phase: 05-template-database-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/00000000000019_group_templates.sql
  - src/shared/types/index.ts
  - CLAUDE.md
autonomous: true

must_haves:
  truths:
    - "Table group_templates exists with id, user_id, name, timestamps"
    - "Table group_template_exercises exists with template_id, exercise_id, parameters, order_index"
    - "Coach can only see and modify their own templates (RLS enforced)"
    - "TypeScript types are available for template entities"
  artifacts:
    - path: "supabase/migrations/00000000000019_group_templates.sql"
      provides: "Database tables, indexes, RLS policies, trigger"
      contains: "create table public.group_templates"
    - path: "src/shared/types/index.ts"
      provides: "TypeScript interfaces for templates"
      contains: "GroupTemplate"
    - path: "CLAUDE.md"
      provides: "Updated database documentation"
      contains: "group_templates"
  key_links:
    - from: "group_template_exercises"
      to: "group_templates"
      via: "template_id foreign key with CASCADE delete"
      pattern: "references public.group_templates.*on delete cascade"
    - from: "group_template_exercises"
      to: "exercises"
      via: "exercise_id foreign key with RESTRICT delete"
      pattern: "references public.exercises.*on delete restrict"
---

<objective>
Create database foundation for reusable group exercise templates.

Purpose: Enable coaches to save and reuse sets of group exercises across sessions. This phase creates the storage layer; UI and MCP integration come in later phases.

Output:
- Migration file with two tables, RLS policies, and indexes
- TypeScript types for template entities
- Updated CLAUDE.md documentation
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-template-database-schema/05-CONTEXT.md
@.planning/phases/05-template-database-schema/05-RESEARCH.md
@supabase/migrations/00000000000018_group_rpc.sql
@src/shared/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration with tables, RLS, and indexes</name>
  <files>supabase/migrations/00000000000019_group_templates.sql</files>
  <action>
Create migration file `00000000000019_group_templates.sql` with:

**Table 1: group_templates**
- id: uuid primary key (gen_random_uuid())
- user_id: uuid references auth.users(id) on delete cascade not null
- name: text not null
- created_at: timestamp with time zone default now()
- updated_at: timestamp with time zone default now()
- Index on user_id for RLS performance
- Trigger using existing `update_updated_at_column()` function

**Table 2: group_template_exercises**
- id: uuid primary key (gen_random_uuid())
- template_id: uuid references group_templates(id) on delete cascade not null
- exercise_id: uuid references exercises(id) on delete restrict not null (RESTRICT, not CASCADE - coach must remove exercise from templates before deleting)
- order_index: integer not null default 0
- sets: integer (nullable)
- reps: integer (nullable)
- weight_kg: numeric(6,2) (nullable)
- duration_seconds: integer (nullable)
- notes: text (nullable)
- created_at: timestamp with time zone default now()
- Indexes: template_id, (template_id, order_index), exercise_id

**RLS Policies for group_templates:**
- Direct ownership pattern: `auth.uid() = user_id`
- Four policies: select, insert, update, delete

**RLS Policies for group_template_exercises:**
- Optimized join pattern: `template_id in (select id from group_templates where user_id = (select auth.uid()))`
- Four policies: select, insert (with check), update, delete

Follow exact SQL structure from 05-RESEARCH.md "Complete Migration" section.
  </action>
  <verify>
Run `npm run supabase:reset` - migration must complete without errors.
Check in Supabase Studio (http://127.0.0.1:54323):
- Both tables exist with correct columns
- RLS is enabled on both tables
- All 4 indexes exist
  </verify>
  <done>
Migration runs successfully. Tables group_templates and group_template_exercises exist with correct schema, RLS enabled, and indexes created.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add TypeScript types and update CLAUDE.md</name>
  <files>src/shared/types/index.ts, CLAUDE.md</files>
  <action>
**TypeScript types** - Add to `src/shared/types/index.ts` after the LumioCardImage interface:

```typescript
// Group Templates

export interface GroupTemplate {
  id: string
  user_id: string
  name: string
  created_at: string
  updated_at: string
}

export interface GroupTemplateInsert {
  name: string
}

export interface GroupTemplateUpdate extends Partial<GroupTemplateInsert> {}

export interface GroupTemplateExercise {
  id: string
  template_id: string
  exercise_id: string
  order_index: number
  sets: number | null
  reps: number | null
  weight_kg: number | null
  duration_seconds: number | null
  notes: string | null
  created_at: string
}

export interface GroupTemplateExerciseInsert {
  template_id: string
  exercise_id: string
  order_index?: number
  sets?: number | null
  reps?: number | null
  weight_kg?: number | null
  duration_seconds?: number | null
  notes?: string | null
}

export interface GroupTemplateExerciseUpdate
  extends Partial<Omit<GroupTemplateExerciseInsert, 'template_id'>> {}

export interface GroupTemplateWithExercises extends GroupTemplate {
  exercises?: GroupTemplateExerciseWithDetails[]
}

export interface GroupTemplateExerciseWithDetails extends GroupTemplateExercise {
  exercise?: ExerciseWithDetails
}
```

**CLAUDE.md** - In the Database section, add to the Tables list:
- `group_templates` - Group exercise templates (user_id, name, timestamps)
- `group_template_exercises` - Exercises in templates (template_id, exercise_id, parameters, order_index)

Pattern: Match existing table entries like `sessions` and `session_exercises`.
  </action>
  <verify>
Run `npx tsc --noEmit` - TypeScript must compile without errors.
Verify CLAUDE.md has both new tables listed in Database section.
  </verify>
  <done>
TypeScript types compile. CLAUDE.md documents both new tables with their columns.
  </done>
</task>

</tasks>

<verification>
1. Migration runs: `npm run supabase:reset` completes without errors
2. Schema correct: Both tables visible in Supabase Studio with all columns
3. RLS active: `alter table ... enable row level security` applied to both tables
4. Indexes exist: 4 indexes visible (user_id, template_id, order, exercise_id)
5. Types compile: `npx tsc --noEmit` passes
6. Docs updated: CLAUDE.md Database section lists both new tables
</verification>

<success_criteria>
- Migration file exists at `supabase/migrations/00000000000019_group_templates.sql`
- Tables group_templates and group_template_exercises created with correct columns
- RLS enabled with 8 policies total (4 per table)
- 4 indexes created for query performance
- TypeScript interfaces exported: GroupTemplate, GroupTemplateInsert, GroupTemplateUpdate, GroupTemplateExercise, GroupTemplateExerciseInsert, GroupTemplateExerciseUpdate, GroupTemplateWithExercises, GroupTemplateExerciseWithDetails
- CLAUDE.md Database section updated with new tables
</success_criteria>

<output>
After completion, create `.planning/phases/05-template-database-schema/05-01-SUMMARY.md`
</output>
