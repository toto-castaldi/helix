---
phase: 15-deploy-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [.github/workflows/deploy.yml]
autonomous: true
requirements: [INFRA-01, INFRA-02]

must_haves:
  truths:
    - "deploy.yml contains a 'Build landing app' step that runs npm run build:landing"
    - "deploy.yml contains a 'Deploy landing app to server' step that uses DEPLOY_PATH_LANDING secret"
    - "deploy.yml contains steps to sync config/ Nginx files to the server and conditionally reload Nginx"
    - "deploy.yml Nginx apply step checks for SSL cert existence before running nginx -t, avoiding failure on servers without certs"
    - "Coach and live app build/deploy steps in deploy.yml are unchanged"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Three-app build and deploy pipeline with Nginx config sync"
      contains: "build:landing"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "dist-landing/"
      via: "npm run build:landing step"
      pattern: "build:landing"
    - from: ".github/workflows/deploy.yml"
      to: "DEPLOY_PATH_LANDING secret"
      via: "ssh-deploy action"
      pattern: "DEPLOY_PATH_LANDING"
    - from: ".github/workflows/deploy.yml"
      to: "/etc/nginx/sites-available/"
      via: "ssh-action config copy step"
      pattern: "sites-available"
---

<objective>
Update the GitHub Actions deploy workflow to build and deploy all three Helix apps (landing, coach, live) and sync Nginx configuration files to the server.

Purpose: The current pipeline only builds and deploys the coach and live apps. The landing page (introduced in Phases 12-13) and the new Nginx configs (from Phase 14) need to be included in the automated CI/CD pipeline so every push to main deploys the full system.

Output: Updated `.github/workflows/deploy.yml` with landing build step, landing deploy step, and cert-aware Nginx config sync.
</objective>

<execution_context>
@/home/toto/.claude/get-shit-done/workflows/execute-plan.md
@/home/toto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-domain-routing/14-01-SUMMARY.md
@.github/workflows/deploy.yml
@config/nginx-helix-coach.conf
@config/nginx-helix-landing.conf
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add landing build step and three-app deploy with cert-aware Nginx sync to deploy.yml</name>
  <files>.github/workflows/deploy.yml</files>
  <action>
Edit `.github/workflows/deploy.yml` to add the following changes:

1. **Add "Build landing app" step** after the existing "Build live app" step:
   ```yaml
   - name: Build landing app
     run: npm run build:landing
     env:
       VITE_APP_VERSION: ${{ steps.version.outputs.version }}
   ```
   Note: Landing page does NOT need VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY (it is a static vanilla JS page with no Supabase dependency).

2. **Add "Deploy landing app to server" step** after the existing "Deploy live app to server" step:
   ```yaml
   - name: Deploy landing app to server
     uses: easingthemes/ssh-deploy@v5.1.0
     with:
       SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
       REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
       REMOTE_USER: ${{ secrets.REMOTE_USER }}
       SOURCE: dist-landing/
       TARGET: ${{ secrets.DEPLOY_PATH_LANDING }}
       ARGS: "-avz --delete"
   ```
   This requires the user to add `DEPLOY_PATH_LANDING` as a GitHub Actions secret (value: `/var/www/helix-landing`).

3. **Add two Nginx config steps** after all deploy steps but before the Supabase section.

   **Step 3a: Deploy Nginx configs to server** — rsync the config/ directory to a temp path:
   ```yaml
   - name: Deploy Nginx configs to server
     uses: easingthemes/ssh-deploy@v5.1.0
     with:
       SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
       REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
       REMOTE_USER: ${{ secrets.REMOTE_USER }}
       SOURCE: config/
       TARGET: /tmp/helix-nginx-config/
       ARGS: "-avz --delete"
   ```

   **Step 3b: Apply Nginx configs and reload** — copy configs to sites-available, handle SSL cert presence gracefully, and reload:
   ```yaml
   - name: Apply Nginx configs and reload
     uses: appleboy/ssh-action@v1
     with:
       host: ${{ secrets.REMOTE_HOST }}
       username: ${{ secrets.REMOTE_USER }}
       key: ${{ secrets.SSH_PRIVATE_KEY }}
       script_stop: true
       script: |
         # Copy landing and coach configs (NOT live - managed separately)
         sudo cp /tmp/helix-nginx-config/nginx-helix-landing.conf /etc/nginx/sites-available/
         sudo cp /tmp/helix-nginx-config/nginx-helix-coach.conf /etc/nginx/sites-available/

         # Ensure symlinks exist in sites-enabled
         sudo ln -sf /etc/nginx/sites-available/nginx-helix-landing.conf /etc/nginx/sites-enabled/
         sudo ln -sf /etc/nginx/sites-available/nginx-helix-coach.conf /etc/nginx/sites-enabled/

         # If SSL certs do NOT exist yet, comment out the 443 server blocks
         # so nginx -t passes with HTTP-only config. Certbot will add SSL later.
         for CONF in nginx-helix-landing.conf nginx-helix-coach.conf; do
           CONF_PATH="/etc/nginx/sites-available/$CONF"
           # Extract domain from server_name in the file
           DOMAIN=$(grep -m1 'server_name' "$CONF_PATH" | awk '{print $2}' | tr -d ';')
           CERT_PATH="/etc/letsencrypt/live/$DOMAIN/fullchain.pem"
           if [ ! -f "$CERT_PATH" ]; then
             echo "SSL cert not found for $DOMAIN — disabling 443 block and HTTP->HTTPS redirect"
             # Comment out the 301 redirect so port 80 serves content directly
             sudo sed -i 's|^\(\s*return 301 https://\)|#\1|' "$CONF_PATH"
             # Add try_files to port-80 block (insert before the closing } of first server block)
             # Actually safer: replace the entire 443 block approach
             # Disable the entire 443 server block by commenting it out
             sudo sed -i '/^server {$/,/^}$/{
               /listen 443/,/^}$/ s/^/#NOSSL#/
             }' "$CONF_PATH"
           else
             echo "SSL cert found for $DOMAIN — enabling SSL lines"
             # Uncomment the certbot SSL lines if they are commented
             sudo sed -i 's|^# \(ssl_certificate\)|    \1|' "$CONF_PATH"
             sudo sed -i 's|^# \(ssl_certificate_key\)|    \1|' "$CONF_PATH"
             sudo sed -i 's|^# \(include /etc/letsencrypt\)|    \1|' "$CONF_PATH"
             sudo sed -i 's|^# \(ssl_dhparam\)|    \1|' "$CONF_PATH"
           fi
         done

         # Test and reload
         sudo nginx -t && sudo systemctl reload nginx

         # Cleanup
         rm -rf /tmp/helix-nginx-config
   ```

   **CRITICAL — Why the cert check is needed:** The source Nginx configs in `config/` have `listen 443 ssl` with SSL certificate directives commented out (placeholder comments from Phase 14). Nginx requires valid `ssl_certificate` and `ssl_certificate_key` directives when `ssl` is on the `listen` directive. Without certs, `nginx -t` would fail and break the pipeline. The cert-existence check above ensures:
   - **First deploy (no certs yet):** 443 block is disabled, only port 80 serves content. Pipeline succeeds.
   - **After certbot runs (Plan 15-02):** Certs exist, SSL lines are uncommented, both 80 (redirect) and 443 work.
   - **Subsequent deploys:** Certs already exist, SSL is enabled automatically.

   **Important:** Do NOT copy the live config (`nginx-helix-live.conf`) because it uses `...` placeholder for SSL in source — it would break the live site. Live config is managed separately on the server.

Order of all steps in the final workflow:
1. Checkout
2. Generate version
3. Update README with version
4. Commit version update
5. Setup Node.js
6. Install dependencies
7. Build main app (coach)
8. Build live app
9. Build landing app (NEW)
10. Deploy main app (coach)
11. Deploy live app
12. Deploy landing app (NEW)
13. Deploy Nginx configs to server (NEW)
14. Apply Nginx configs and reload (NEW)
15. Setup Supabase CLI
16. Link Supabase
17. Backup Database
18. Upload Backup Artifact
19. Run Database Migrations
20. Deploy Edge Functions
  </action>
  <verify>
Run: `cat .github/workflows/deploy.yml` and confirm:
- "Build landing app" step exists with `npm run build:landing`
- "Deploy landing app to server" step exists with `DEPLOY_PATH_LANDING` secret
- "Deploy Nginx configs to server" step exists targeting /tmp/helix-nginx-config/
- "Apply Nginx configs and reload" step exists with cert-existence check (`if [ ! -f "$CERT_PATH" ]`)
- The script comments out the 443 block when certs are missing (grep for `#NOSSL#` or equivalent)
- The script uncomments SSL lines when certs exist
- Script ends with `sudo nginx -t && sudo systemctl reload nginx`
- Existing steps for coach and live builds/deploys are unchanged
- Landing build does NOT reference VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY
- Live config (`nginx-helix-live.conf`) is NOT referenced in any copy/cp command
  </verify>
  <done>
deploy.yml contains build+deploy steps for all three apps (coach, live, landing) plus cert-aware Nginx config sync that handles both pre-certbot (HTTP-only) and post-certbot (full SSL) states, and all existing steps remain unchanged.
  </done>
</task>

</tasks>

<verification>
1. Verify deploy.yml is valid YAML: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/deploy.yml'))"`
2. Confirm "Build landing app" step exists
3. Confirm "Deploy landing app" step uses DEPLOY_PATH_LANDING secret
4. Confirm Nginx config deploy and reload steps exist
5. Confirm the Apply step has cert-existence conditional logic
6. Confirm existing coach/live build and deploy steps are unchanged
7. Confirm the landing build step does NOT include Supabase env vars
8. Confirm live config is not copied
</verification>

<success_criteria>
- deploy.yml builds landing, coach, and live in one pipeline
- Landing build deploys to DEPLOY_PATH_LANDING
- Nginx configs are synced with cert-aware logic (no failure when certs missing)
- Existing pipeline behavior for coach, live, Supabase, and Edge Functions is unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/15-deploy-pipeline/15-01-SUMMARY.md`
</output>
